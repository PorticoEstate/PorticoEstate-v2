{# twig #}
<style type="text/css">
	.card-img-top {
		width: 100%;
		height: 250px;
		object-fit: cover;
	}

	tr.clickable-row {
		cursor: pointer;
		color: #0275d8;
	}

	tr.clickable-row:hover {
		color: #224ac1;
		background-color: #f7f7f7;
	}

	* ==========================================
	* CUSTOM UTIL CLASSES
	* ==========================================
	*
	*/

	a:hover, a:focus {
		text-decoration: none;
		outline: none;
	}
	#accordion .panel {
		border: none;
		border-radius: 0;
		box-shadow: none;
		margin-bottom: 15px;
		position: relative;
	}
	#accordion .panel:before {
		content: "";
		display: block;
		width: 1px;
		height: 100%;
		border: 1px dashed #0275d8;
		position: absolute;
		top: 25px;
		left: 18px;
	}
	#accordion .panel:last-child:before { display: none; }
	#accordion .panel-heading {
		padding: 0;
		border: none;
		border-radius: 0;
		position: relative;
	}
	#accordion .panel-title a {
		display: block;
		padding: 10px 30px 10px 60px;
		margin: 0;
		background: #fff;
		font-size: 18px;
		font-weight: 700;
		letter-spacing: 1px;
		color: #1d3557;
		border-radius: 0;
		position: relative;
	}
	#accordion .panel-title a:before,
	#accordion .panel-title a.collapsed:before {
		content: "\f107";
		font-family: "Font Awesome 5 Free";
		font-weight: 900;
		width: 40px;
		height: 100%;
		line-height: 40px;
		background: #0275d8;
		border: 1px solid #0275d8;
		border-radius: 3px;
		font-size: 17px;
		color: #fff;
		text-align: center;
		position: absolute;
		top: 0;
		left: 0;
		transition: all 0.3s ease 0s;
	}
	#accordion .panel-title a.collapsed:before {
		content: "\f105";
		background: #fff;
		border: 1px solid #0275d8;
		color: #000;
	}
	#accordion .panel-body {
		padding: 10px 30px 10px 30px;
		margin-left: 40px;
		background: #fff;
		border-top: none;
		font-size: 15px;
		color: #6f6f6f;
		line-height: 28px;
		letter-spacing: 1px;
	}

	.app-dropdown-item.disabled,
	.app-dropdown-item[disabled] {
		opacity: 0.5;
		pointer-events: none;
		cursor: not-allowed;
	}

	.pure-form-contentTable {display: inline-block;}
</style>

{% set messenger_enabled = get_phpgw_info('user|apps|messenger|enabled') %}
{% set case_officer = application.case_officer|default(null) %}
{% set case_officer_is_current_user = case_officer and case_officer.is_current_user %}
{% set case_officer_id = application.case_officer_id|default('') %}
{% set case_officer_display_name = application.case_officer_full_name|default(application.case_officer_name|default('')) %}
{% set agegroup_lookup = {} %}
{% for ag in agegroups %}
	{% set agegroup_lookup = agegroup_lookup|merge({ (ag.id): ag.name }) %}
{% endfor %}
{% set app_agegroups = {} %}
{% for ag in application.agegroups|default([]) %}
	{% set app_agegroups = app_agegroups|merge({ (ag.agegroup_id): ag }) %}
{% endfor %}

{% if msgbox_data is defined and msgbox_data %}
	{% if msgbox_data is iterable and (msgbox_data|first is iterable) %}
		{% for message in msgbox_data %}
			<div class="{{ message.msgbox_class|default('error') }}">
				{% if message.msgbox_img %}
					<img src="{{ message.msgbox_img }}" alt="{{ message.msgbox_img_alt }}" title="{{ message.msgbox_img_alt }}" />
				{% endif %}
				{{ message.msgbox_text|raw }}
			</div>
		{% endfor %}
	{% else %}
		<div class="{{ msgbox_data.msgbox_class|default('error') }}">
			{% if msgbox_data.msgbox_img %}
				<img src="{{ msgbox_data.msgbox_img }}" alt="{{ msgbox_data.msgbox_img_alt }}" title="{{ msgbox_data.msgbox_img_alt }}" />
			{% endif %}
			{{ msgbox_data.msgbox_text|raw }}
		</div>
	{% endif %}
{% endif %}

<div class="app-container-fluid">
	<div class="app-row mt-4">
		<div class="app-col-6">
			<ul class="list-inline">
				<li class="list-inline-item mb-2">
					<div class="app-dropdown">
						<button class="app-button app-button-success app-button-circle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							<i class="fas fa-reply" aria-hidden="true" title="Send svar eller opprett notat i saken"></i>
						</button>
						<div class="app-dropdown-menu animated--fade-in" aria-labelledby="dropdownMenuButton">
							<a class="app-dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#commentModal" {% if not case_officer_is_current_user %}style="opacity: 0.5; pointer-events: none;"{% endif %}>
								<i class="fas fa-reply me-1 {{ case_officer_is_current_user ? 'text-success' : 'text-secondary' }}"></i>
								Send svar til innsender
							</a>
							<a class="app-dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#messengerModal" {% if messenger_enabled != 'true' or case_officer_is_current_user or case_officer_id == '' %}style="opacity: 0.5; pointer-events: none;"{% endif %}>
								<i class="fas fa-reply me-1 {{ (messenger_enabled != 'true' or case_officer_is_current_user or case_officer_id == '') ? 'text-secondary' : 'text-success' }}"></i>
								Send melding til saksbehandler
							</a>
							<a class="app-dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#internal_noteModal" {% if not case_officer_is_current_user %}style="opacity: 0.5; pointer-events: none;"{% endif %}>
								<i class="far fa-sticky-note me-1 {{ case_officer_is_current_user ? 'text-warning' : 'text-secondary' }}"></i>
								Opprett internt notat
							</a>
						</div>
					</div>
				</li>
				<li class="list-inline-item mb-2">
					<div class="app-dropdown">
						<button class="app-button app-button-warning app-button-circle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							<i class="fas fa-arrow-right" aria-hidden="true" title="Videresend sak"></i>
						</button>
						<div class="app-dropdown-menu animated--fade-in" aria-labelledby="dropdownMenuButton">
							<a class="app-dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#change_userModal">
								<i class="fas fa-arrow-right me-1 text-warning"></i>Sett sak til en annen saksbehandler
							</a>
						</div>
					</div>
				</li>
				<li class="list-inline-item mb-2">
					<div class="app-dropdown" id="action_dropdown">
						<button class="app-button app-button-primary app-button-circle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							<i class="fas fa-flag" aria-hidden="true" title="Flere handlinger"></i>
						</button>
						<div id="return_after_action" class="app-dropdown-menu animated--fade-in" aria-labelledby="dropdownMenuButton">
							{% if case_officer_is_current_user %}
								<form method="POST" style="display:inline">
									<input type="hidden" name="unassign_user" />
									<button type="submit" class="app-dropdown-item">
										<i class="fas fa-flag me-1 text-primary"></i>
										{{ lang('Unassign me') }}
									</button>
								</form>
								<form method="POST" style="display:inline">
									<input type="hidden" name="display_in_dashboard" value="{{ application.display_in_dashboard == '1' ? '0' : '1' }}" />
									<button type="submit" class="app-dropdown-item">
										<i class="fas fa-flag me-1 text-primary"></i>
										{{ lang(application.display_in_dashboard == '1' ? 'Hide from my Dashboard until new activity occurs' : 'Display in my Dashboard') }}
									</button>
								</form>
							{% else %}
								<form method="POST">
									<input type="hidden" name="assign_to_user" />
									<input type="hidden" name="status" value="PENDING" />
									<button type="submit" class="app-dropdown-item">
										<i class="fas fa-flag me-1 text-primary"></i>
										{{ lang(case_officer ? 'Re-assign to me' : 'Assign to me') }}
									</button>
								</form>
							{% endif %}

							{% if application.status != 'REJECTED' %}
								<form method="POST">
									<input type="hidden" name="status" value="REJECTED" />
									<button type="button" class="app-dropdown-item{% if not case_officer_is_current_user %} disabled{% endif %}" data-bs-toggle="modal" data-bs-target="#rejectApplicationModal" {% if not case_officer_is_current_user %}disabled="disabled" aria-disabled="true"{% endif %}>
										<i class="fas fa-flag me-1 {{ case_officer_is_current_user ? 'text-primary' : 'text-secondary' }}"></i>
										{{ lang('Reject application') }}
									</button>
								</form>
							{% endif %}
							{% if application.status == 'PENDING' or application.status == 'REJECTED' or application.status == 'NEWPARTIAL1' %}
								{% if num_associations == '0' %}
									<button type="submit" disabled="disabled" value="{{ lang('Accept application') }}" class="app-dropdown-item">
										<i class="fas fa-flag me-1 text-secondary"></i>
										{{ lang('One or more bookings, allocations or events needs to be created before an application can be Accepted') }}
									</button>
								{% else %}
									<div>
										<button type="button" class="app-dropdown-item{% if not case_officer_is_current_user %} disabled{% endif %}" data-bs-toggle="modal" data-bs-target="#acceptApplicationModal" {% if not case_officer_is_current_user %}disabled="disabled" aria-disabled="true"{% endif %}>
											<i class="fas fa-flag me-1 {{ case_officer_is_current_user ? 'text-primary' : 'text-secondary' }}"></i>
											{{ lang('Accept application') }}
										</button>
									</div>
								{% endif %}
							{% endif %}
							<div>
								{% if external_archive != '' and application.external_archive_key == '' %}
									<form method="POST" action="{{ export_pdf_action }}">
										<input type="hidden" name="export" value="pdf" />
										<button onclick="return confirm('{{ lang('transfer case to external system?') }}')" type="submit" class="app-dropdown-item" {% if not case_officer_is_current_user %}disabled="disabled"{% endif %}>
											<i class="fas fa-flag me-1 text-primary"></i>
											{{ lang('PDF-export to archive') }}
										</button>
									</form>
									<form method="POST" action="{{ export_pdf_action }}">
										<input type="hidden" name="export" value="pdf" />
										<input type="hidden" name="preview" value="1" />
										<button onclick="return confirm('{{ lang('transfer case to external system?') }}')" type="submit" class="app-dropdown-item" {% if not case_officer_is_current_user %}disabled="disabled"{% endif %}>
											<i class="fas fa-flag me-1 text-primary"></i>
											{{ lang('PDF-export to archive') }} ({{ lang('preview') }})
										</button>
									</form>
								{% endif %}
							</div>

							{% if application.edit_link %}
								<button class="app-dropdown-item{% if not case_officer_is_current_user %} disabled{% endif %}" {% if not case_officer_is_current_user %}disabled="disabled" aria-disabled="true"{% else %}onclick="window.location.href='{{ application.edit_link }}{% if show_edit_selection == 1 %}&selected_app_id={{ application.parent_id ? application.parent_id : application.id }}&only_invoicing=true{% endif %}'"{% endif %}>
									<i class="fas fa-edit me-1 {{ case_officer_is_current_user ? 'text-primary' : 'text-secondary' }}"></i>
									{{ lang('Edit') }}
								</button>
							{% endif %}
							<a class="app-dropdown-item" href="{{ application.dashboard_link }}">
								<i class="fas fa-flag me-1 text-primary"></i>
								{{ lang('Back to Dashboard') }}
							</a>
							<a class="app-dropdown-item" href="{{ phpgw_link('/index.php', {'menuaction': 'booking.uiapplication.index'}) }}">
								<i class="fas fa-flag me-1 text-primary"></i>Tilbake til hovedoversikt
							</a>
						</div>
					</div>
				</li>

				{% if show_recurring_button == 1 %}
					<li class="list-inline-item mb-2">
						<a class="app-button app-button-success app-button-sm shadow-sm" role="button" href="{{ recurring_allocation_url }}" title="Opprett gjentakende tildeling basert på denne søknaden">
							<i class="fas fa-calendar-plus me-2"></i>
							<span class="fw-medium">Opprett gjentakende tildeling</span>
						</a>
					</li>
				{% endif %}
			</ul>
		</div>
		<div class="app-col-6">
			<ul class="list-inline float-end" role="tablist">
				<li class="nav-item list-inline-item me-2">
					<button class="app-button app-button-primary active border" data-bs-toggle="tab" data-bs-target="#booking">
						<i class="fas fa-calendar-alt fa-2x" aria-hidden="true" title="Søknad"></i>
					</button>
				</li>
				<li class="nav-item list-inline-item me-2">
					<button class="app-button app-button-warning border" data-bs-toggle="tab" data-bs-target="#internal_notes">
						<i class="far fa-sticky-note fa-2x text-warning" aria-hidden="true" title="Interne notat"></i>
					</button>
				</li>
				<li class="nav-item list-inline-item me-2">
					<button class="app-button app-button-primary border" data-bs-toggle="tab" data-bs-target="#history">
						<i class="fas fa-history fa-2x" aria-hidden="true" title="Historikk"></i>
					</button>
				</li>
			</ul>
		</div>
	</div>

	<div class="app-row"></div>

	<div class="tab-content">
		<div class="tab-pane active" id="booking">
			<div class="clearfix"></div>

			<div class="d-flex flex-column mt-3">
				<div class="d-flex w-100 justify-content-between">
					<h5 class="mb-0">{{ lang('case officer') }}</h5>
					<small></small>
				</div>
				<p class="mb-0 font-weight-bold">
					{% if case_officer_display_name != '' %}
						{{ case_officer_display_name }}
					{% else %}
						{{ lang('none') }}
					{% endif %}
				</p>
				<div class="d-flex w-100">
					{% if not case_officer %}
						<div class="app-alert app-alert-info alert alert-info" role="alert">
							For å jobbe med denne søknaden, må du først bli saksbehander for denne søknaden
						</div>
					{% elseif case_officer and not case_officer_is_current_user %}
						<div class="app-alert app-alert-info" role="alert">
							{{ lang('The user currently assigned as the responsible case officer for this application is') }} '{{ case_officer_display_name }}'.
							<br/>
							{{ lang('In order to work with this application, you must therefore first') }} {{ lang('assign yourself') }} {{ lang('as the case officer responsible for this application.') }}
						</div>
					{% else %}
						<div style="display:none"></div>
					{% endif %}
				</div>

				{% if application.related_application_count <= 1 %}
					<div class="d-flex w-100 justify-content-between">
						<p class="mb-0 mt-3">{{ lang('Status') }}</p>
					</div>
					<p class="mb-0">{{ lang(application.status) }}</p>
					<div class="d-flex w-100 justify-content-between">
						<p class="mb-0 mt-3">{{ lang('Created') }}</p>
					</div>
					<p class="mb-0">{{ pretty_timestamp(application.created) }}</p>
					<div class="d-flex w-100 justify-content-between">
						<p class="mb-0 mt-3">{{ lang('Modified') }}</p>
					</div>
					<p class="mb-0">{{ pretty_timestamp(application.modified) }}</p>
				{% endif %}
				{% if application.external_archive_key != '' %}
					<div class="d-flex w-100 justify-content-between">
						<p class="mb-0 mt-3">{{ lang('external archive key') }}</p>
					</div>
					<p class="mb-0">{{ application.external_archive_key }}</p>
				{% endif %}
			</div>

			<div class="app-row mt-3">
				<div class="app-container-fluid">
					<div class="app-row">
						<div class="app-col">
							{% if application.related_application_count > 1 %}
								<div class="app-alert app-alert-info mb-4">
									<h5 class="app-alert-heading pb-2">
										<i class="fas fa-info-circle me-2"></i>
										{{ lang('combined_application') }}
										<span class="app-badge app-badge-primary ms-2">{{ application.related_application_count }}</span>
									</h5>

									<div class="app-row">
										{% for related in application.related_applications_info %}
											<div class="app-col-6 mb-3">
												<div class="app-card app-card-bordered">
													<div class="app-card-body p-3">
														<div class="d-flex justify-content-between align-items-start mb-2">
															<div>
																<h6 class="app-card-title mb-1"><strong>{{ related.name }}</strong></h6>
																<p class="app-card-text mb-0">
																	<strong>{{ lang('Application') }} #{{ related.id }}</strong>
																</p>
															</div>
															<a class="app-button app-button-sm app-button-primary" href="{{ application.edit_link }}&selected_app_id={{ related.id }}&hide_invoicing=1">
																<i class="fas fa-edit me-1"></i>{{ lang('Edit') }}
															</a>
														</div>
														<p class="app-card-text mb-1"><small><strong>{{ lang('Status') }}:</strong></small></p>
														<p class="app-card-text mb-2"><small><span class="app-badge app-badge-primary">{{ lang(related.status) }}</span></small></p>
														<p class="app-card-text mb-1"><small><strong>{{ lang('Created') }}:</strong></small></p>
														<p class="app-card-text mb-2"><small>{{ related.created }}</small></p>
														{% if related.agegroups %}
															{% set total_male = 0 %}
															{% set total_female = 0 %}
															{% for ag in related.agegroups %}
																{% set total_male = total_male + ag.male %}
																{% set total_female = total_female + ag.female %}
															{% endfor %}
															{% set total_participants = total_male + total_female %}
															{% if total_participants > 0 %}
																<p class="app-card-text mb-1"><small><strong>{{ lang('participants') }}:</strong></small></p>
																<p class="app-card-text mb-2"><small>{{ total_participants }}</small></p>
															{% endif %}
														{% endif %}
														{% if related.date_ranges %}
															<p class="app-card-text mb-1"><small><strong>{{ lang('timeslots') }}:</strong></small></p>
															<ul class="list-unstyled mb-2">
																{% for range in related.date_ranges %}
																	<li><small>• {{ range }}</small></li>
																{% endfor %}
															</ul>
														{% endif %}
														{% if related.resource_names %}
															<p class="app-card-text mb-1"><small><strong>{{ lang('Resources') }}:</strong></small></p>
															<p class="app-card-text"><small>{{ related.resource_names|join(', ') }}</small></p>
														{% endif %}
														{% if related.equipment and related.equipment|trim %}
															<p class="app-card-text mb-1"><small><strong>{{ lang('Equipment (2018)') }}:</strong></small></p>
															<p class="app-card-text"><small>{{ related.equipment|raw }}</small></p>
														{% endif %}
														{% if related.description and related.description|trim %}
															<p class="app-card-text mb-1"><small><strong>{{ lang('Description') }}:</strong></small></p>
															<p class="app-card-text"><small>{{ related.description|raw }}</small></p>
														{% endif %}
													</div>
												</div>
											</div>
										{% endfor %}
									</div>
								</div>
							{% endif %}

							<div class="app-panel-group" id="accordion" role="tablist" aria-multiselectable="true">
								<div class="app-panel app-panel-default">
									<div class="app-panel-heading" role="tab" id="headingOne">
										<h4 class="app-panel-title">
											<a role="button" data-bs-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne" class="">Søker: {{ application.contact_name }}</a>
										</h4>
									</div>
									<div id="collapseOne" class="app-panel-collapse collapse show" role="tabpanel" aria-labelledby="headingOne">
										<div class="app-panel-body">
											<div class="app-list-group">
												<div class="app-list-group-item flex-column align-items-start">
													<div class="d-flex w-100 justify-content-between">
														<h5 class="mb-1">{{ lang('Name') }}</h5>
														<small></small>
													</div>
													<p class="mb-1 font-weight-bold">{{ application.contact_name }}</p>
												</div>
												<div class="app-list-group-item flex-column align-items-start">
													<div class="d-flex w-100 justify-content-between">
														<h5 class="mb-1">{{ lang('Email') }}</h5>
														<small class="text-body-secondary"></small>
													</div>
													<p class="mb-1 font-weight-bold">{{ application.contact_email }}</p>
													<small class="text-body-secondary"></small>
												</div>
												<div class="app-list-group-item flex-column align-items-start">
													<div class="d-flex w-100 justify-content-between">
														<h5 class="mb-1">{{ lang('Phone') }}</h5>
														<small class="text-body-secondary"></small>
													</div>
													<p class="mb-1 font-weight-bold">{{ application.contact_phone }}</p>
													<small class="text-body-secondary"></small>
												</div>
											</div>
										</div>
									</div>
								</div>

								{% if application.customer_organization_name != '' %}
									<div class="app-panel app-panel-default">
										<div class="app-panel-heading" role="tab" id="headingTwo">
											<h4 class="app-panel-title">
												<a class="" role="button" data-bs-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
													{{ lang('Organization') }}: {{ application.customer_organization_name }}
												</a>
											</h4>
										</div>
										<div id="collapseTwo" class="app-panel-collapse collapse show" role="tabpanel" aria-labelledby="headingTwo">
											<div class="app-panel-body">
												<div class="app-list-group">
													<div class="app-list-group-item flex-column align-items-start">
														<div class="d-flex w-100 justify-content-between">
															<h5 class="mb-1">{{ lang('Organization') }}</h5>
															<small>Hentet fra enhetsregisteret</small>
														</div>
														<p class="mb-1 font-weight-bold">{{ application.customer_organization_name }}</p>
													</div>
													{% if application.customer_identifier_type == 'organization_number' %}
														<div class="app-list-group-item flex-column align-items-start">
															<div class="d-flex w-100 justify-content-between">
																<h5 class="mb-1">{{ lang('organization number') }}</h5>
																<small class="text-body-secondary"></small>
															</div>
															<p class="mb-1 font-weight-bold">{{ application.customer_organization_number }}</p>
															<small class="text-body-secondary"></small>
														</div>
													{% endif %}
													<div class="app-list-group-item flex-column align-items-start">
														<div class="d-flex w-100 justify-content-between">
															<h5 class="mb-1">{{ lang('in tax register') }}</h5>
															<small class="text-body-secondary">Hentet fra brukerinput</small>
														</div>
														<p class="mb-1 font-weight-bold">{{ (organization.in_tax_register|default(0)) == 1 ? lang('yes') : lang('no') }}</p>
														<small class="text-body-secondary"></small>
													</div>
												</div>
											</div>
										</div>
									</div>
								{% endif %}

								<div class="app-panel app-panel-default">
									<div class="app-panel-heading" role="tab" id="headingTwelve">
										<h4 class="app-panel-title">
											<a class="" role="button" data-bs-toggle="collapse" data-parent="#accordion" href="#collapseTwelve" aria-expanded="true" aria-controls="collapseTwelve">
												{{ lang('invoice information') }}
											</a>
										</h4>
									</div>
									<div id="collapseTwelve" class="app-panel-collapse collapse show" role="tabpanel" aria-labelledby="headingTwelve">
										<div class="app-panel-body">
											<div class="app-list-group">
												{% if application.customer_identifier_type == 'organization_number' %}
													<div class="app-list-group-item flex-column align-items-start">
														<div class="d-flex w-100 justify-content-between">
															<h5 class="mb-1">{{ lang('organization number') }}</h5>
															<small class="text-body-secondary"></small>
														</div>
														<p class="mb-1 font-weight-bold">{{ application.customer_organization_number }}</p>
														<small class="text-body-secondary"></small>
													</div>
												{% endif %}
												{% if application.customer_identifier_type == 'ssn' %}
													<div class="app-list-group-item flex-column align-items-start">
														<div class="d-flex w-100 justify-content-between">
															<h5 class="mb-1">{{ lang('Date of birth or SSN') }}</h5>
															<small class="text-body-secondary">Hentet fra ID-Porten</small>
														</div>
														<p class="mb-1 font-weight-bold">{{ application.customer_ssn|slice(0, 6) }}*****</p>
														<small class="text-body-secondary"></small>
													</div>
												{% endif %}
												<div class="app-list-group-item flex-column align-items-start">
													<div class="d-flex w-100 justify-content-between">
														<h5 class="mb-1">{{ lang('Street') }}</h5>
														<small class="text-body-secondary">Hentet fra brukerinput</small>
													</div>
													<p class="mb-1 font-weight-bold">{{ application.responsible_street }}</p>
													<small class="text-body-secondary"></small>
												</div>
												<div class="app-list-group-item flex-column align-items-start">
													<div class="d-flex w-100 justify-content-between">
														<h5 class="mb-1">{{ lang('Zip code') }}</h5>
														<small class="text-body-secondary">Hentet fra brukerinput</small>
													</div>
													<p class="mb-1 font-weight-bold">{{ application.responsible_zip_code }}</p>
													<small class="text-body-secondary"></small>
												</div>
												<div class="app-list-group-item flex-column align-items-start">
													<div class="d-flex w-100 justify-content-between">
														<h5 class="mb-1">{{ lang('Postal City') }}</h5>
														<small class="text-body-secondary">Hentet fra brukerinput</small>
													</div>
													<p class="mb-1 font-weight-bold">{{ application.responsible_city }}</p>
													<small class="text-body-secondary"></small>
												</div>
											</div>
										</div>
									</div>
								</div>

								{% if simple != 1 %}
									<div class="app-panel app-panel-default">
										<div class="app-panel-heading" role="tab" id="headingThree">
											<h4 class="app-panel-title">
												<a class="" role="button" data-bs-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">{{ lang('Who?') }}</a>
											</h4>
										</div>
										<div id="collapseThree" class="app-panel-collapse collapse show" role="tabpanel" aria-labelledby="headingThree">
											<div class="app-panel-body">
												<div class="app-list-group">
													<div class="app-list-group-item flex-column align-items-start">
														<div class="d-flex w-100 justify-content-between">
															<h5 class="mb-1">{{ lang('Target audience') }}</h5>
															<small></small>
														</div>
														<p class="mb-1 font-weight-bold">
															<ul class="list-left">
																{% for item in audience %}
																	{% if item.id in application.audience %}
																		<li>{{ item.name }}</li>
																	{% endif %}
																{% endfor %}
															</ul>
														</p>
														<small></small>
													</div>
													<div class="app-list-group-item flex-column align-items-start">
														{% if application.related_application_count > 1 %}
															{% for related in application.related_applications_info %}
																{% if related.agegroups %}
																	<div class="app-card-body">
																		<h6 class="app-card-title">
																			<strong>{{ related.name }} (#{{ related.id }})</strong>
																		</h6>
																		<div class="pure-form-contentTable">
																			<table class="pure-table pure-table-striped">
																				<thead>
																					<tr>
																						<th>{{ lang('Name') }}</th>
																						<th>{{ lang('participants') }}</th>
																					</tr>
																				</thead>
																				<tbody>
																					{% for ag in related.agegroups %}
																						{% set total = ag.male + ag.female %}
																						{% if total > 0 %}
																							<tr>
																								<td>{{ agegroup_lookup[ag.agegroup_id]|default('') }}</td>
																								<td>{{ total }}</td>
																							</tr>
																						{% endif %}
																					{% endfor %}
																				</tbody>
																			</table>
																		</div>
																	</div>
																{% endif %}
															{% endfor %}
														{% else %}
															<div class="pure-form-contentTable">
																<table id="agegroup" class="pure-table pure-table-striped">
																	<thead>
																		<tr>
																			<th>{{ lang('Name') }}</th>
																			<th>{{ lang('Male') }}</th>
																			<th>{{ lang('Female') }}</th>
																		</tr>
																	</thead>
																	<tbody>
																		{% for ag in agegroups %}
																			{% set app_ag = app_agegroups[ag.id]|default(null) %}
																			{% if app_ag and (app_ag.male > 0 or app_ag.female > 0) %}
																				<tr>
																					<td>{{ ag.name }}</td>
																					<td>{{ app_ag.male }}</td>
																					<td>{{ app_ag.female }}</td>
																				</tr>
																			{% endif %}
																		{% endfor %}
																	</tbody>
																</table>
															</div>
														{% endif %}
														<small></small>
													</div>
												</div>
											</div>
										</div>
									</div>
								{% endif %}

								{% if simple != 1 %}
									<div class="app-panel app-panel-default">
										<div class="app-panel-heading" role="tab" id="headingFour">
											<h4 class="app-panel-title">
												<a class="" role="button" data-bs-toggle="collapse" data-parent="#accordion" href="#collapseFour" aria-expanded="true" aria-controls="collapseFour">{{ lang('Why?') }}</a>
											</h4>
										</div>
										<div id="collapseFour" class="app-panel-collapse collapse show" role="tabpanel" aria-labelledby="headingFour">
											<div class="app-panel-body">
												<div class="app-list-group">
													<div class="app-list-group-item flex-column align-items-start">
														<div class="d-flex w-100 justify-content-between">
															<h5 class="mb-1">{{ lang('Activity') }}</h5>
														</div>
														<p class="mb-1 font-weight-bold">{{ application.activity_name }}</p>
													</div>
													<div class="app-list-group-item flex-column align-items-start">
														<div class="d-flex w-100 justify-content-between">
															<h5 class="mb-1">{{ lang('Event name') }}</h5>
														</div>
														<p class="mb-1 font-weight-bold">{{ application.name|raw }}</p>
													</div>
													<div class="app-list-group-item flex-column align-items-start">
														<div class="d-flex w-100 justify-content-between">
															<h5 class="mb-1">{{ lang('Description') }}</h5>
														</div>
														<p class="mb-1 font-weight-bold">{{ application.description|raw }}</p>
													</div>
													<div class="app-list-group-item flex-column align-items-start">
														<div class="d-flex w-100 justify-content-between">
															<h5 class="mb-1">{{ lang('Extra info') }}</h5>
														</div>
														<p class="mb-1 font-weight-bold">{{ application.equipment|raw }}</p>
													</div>
													<div class="app-list-group-item flex-column align-items-start">
														<div class="d-flex w-100 justify-content-between">
															<h5 class="mb-1">{{ lang('Organizer') }}</h5>
														</div>
														<p class="mb-1 font-weight-bold">{{ application.organizer|raw }}</p>
													</div>
													<div class="app-list-group-item flex-column align-items-start">
														<div class="d-flex w-100 justify-content-between">
															<h5 class="mb-1">{{ lang('Homepage') }}</h5>
														</div>
														<p class="mb-1 font-weight-bold">
															{% if application.homepage and application.homepage|trim %}
																<a href="{{ application.homepage }}">{{ application.homepage }}</a>
															{% endif %}
														</p>
													</div>
												</div>
											</div>
									</div>
								{% endif %}

								<div class="app-panel app-panel-default">
									<div class="app-panel-heading" role="tab" id="headingFive">
										<h4 class="app-panel-title">
											<a class="" role="button" data-bs-toggle="collapse" data-parent="#accordion" href="#collapseFive" aria-expanded="true" aria-controls="collapseFive">
												Ønsker ressurs: <i class="fas fa-redo-alt text-primary"></i>
											</a>
										</h4>
									</div>

									<div id="collapseFive" class="app-panel-collapse collapse show" role="tabpanel" aria-labelledby="headingFive">
										<div class="app-panel-body">
											<div class="app-list-group">
												<div class="app-list-group-item flex-column align-items-start">
													<div class="d-flex w-100 justify-content-between">
														<h5 class="mb-1">{{ lang('Building') }}</h5>
													</div>
													<p class="mb-1 font-weight-bold">
														{{ application.building_name }}
														(<a href="javascript: void(0)" onclick="window.open('{{ application.schedule_link }}', '', 'width=1048, height=600, scrollbars=yes');return false;">{{ lang('Building schedule') }}</a>)
													</p>

													{% if application.related_application_count > 1 %}
														<p class="mb-1" style="font-weight: bold; color: #2c5aa0;">
															{{ application.related_application_count }} applications combined
														</p>
													{% endif %}
												</div>
											</div>

											<div class="app-list-group">
												<div class="app-list-group-item flex-column align-items-start">
													<div id="articles_container" style="display:inline-block;"></div>
												</div>
											</div>
										</div>
									</div>
								</div>

								<div class="app-panel app-panel-default">
									<div class="app-panel-heading" role="tab" id="headingSix">
										<h4 class="app-panel-title">
											<a class="" role="button" data-bs-toggle="collapse" data-parent="#accordion" href="#collapseSix" aria-expanded="true" aria-controls="collapseSix">{{ lang('when_and_where') }}</a>
										</h4>
									</div>

									<div id="collapseSix" class="app-panel-collapse collapse show" role="tabpanel" aria-labelledby="headingSix">
										<div class="app-panel-body">
											<p>{{ lang('date format') }}: {{ get_phpgw_info('user|preferences|common|dateformat') }}</p>
											<div class="app-list-group">
												<div class="app-list-group-item flex-column align-items-start">
													<script type="text/javascript">
														var allocationParams = {};
														var bookingParams = {};
														var eventParams = {};
														var applicationDate = {};
													</script>
													{% set assocdata = assoc.data %}
													{% set collisiondata = collision.data %}
													<script type="text/javascript">
														building_id = {{ application.building_id }};
													</script>
													{% for date in application.combined_dates %}
														<div class="app-card mb-3" style="border: 1px solid #ddd;">
															<div class="app-card-body">
																{% if date.application_name %}
																	<div class="pure-control-group">
																		<label style="font-weight: bold; color: #2c5aa0;">{{ lang('Application') }}:</label>
																		<span style="font-weight: bold;">{{ date.application_name }} (#{{ date.application_id }})</span>
																	</div>
																{% endif %}
																<div class="pure-control-group">
																	<label style="font-weight: bold;">{{ lang('timeslot') }}:</label>
																	<span>{{ pretty_timestamp(date.from_) }} - {{ pretty_timestamp(date.to_) }}</span>
																	{% if case_officer_is_current_user %}
																		{% if collisiondata and date.from_ in collisiondata and assocdata and (date.from_ not in assocdata) %}
																			<a href="javascript: void(0)" onclick="open_schedule(building_id,'{{ date.from_ }}');return false;">
																				<i class="fa fa-exclamation-circle"></i>
																			</a>
																		{% endif %}
																	{% endif %}
																</div>
																<div class="pure-control-group">
																	<label>{{ lang('Resources') }}:</label>
																	<span>{{ date.resource_names != '' ? date.resource_names : 'No resources specified' }}</span>
																</div>
																{% if date.equipment and date.equipment|trim %}
																	<div class="pure-control-group">
																		<label>{{ lang('Equipment (2018)') }}:</label>
																		<span>{{ date.equipment|raw }}</span>
																	</div>
																{% endif %}
															</div>
														</div>
														{% if application.edit_link %}
															<script type="text/javascript">
																allocationParams[{{ date.id }}] = {{ date.allocation_params|raw }};
																bookingParams[{{ date.id }}] = {{ date.booking_params|raw }};
																eventParams[{{ date.id }}] = {{ date.event_params|raw }};
															</script>
															<div class="pure-control-group">
																<label>&nbsp;</label>
																<select name="create" onchange="if(this.selectedIndex==1) JqueryPortico.booking.postToUrl('index.php?menuaction=booking.uiallocation.add', allocationParams[{{ date.id }}]); if(this.selectedIndex==2) JqueryPortico.booking.postToUrl('index.php?menuaction=booking.uibooking.add', eventParams[{{ date.id }}]); if(this.selectedIndex==3) JqueryPortico.booking.postToUrl('index.php?menuaction=booking.uievent.add', eventParams[{{ date.id }}]);" {% if not case_officer_is_current_user or (assocdata and date.from_ in assocdata) %}disabled="disabled"{% endif %}>
																	{% if not assocdata or (date.from_ not in assocdata) %}
																		<option>{{ lang('- Actions -') }}</option>
																		<option>{{ lang('Create allocation') }}</option>
																		<option>{{ lang('Create booking') }}</option>
																		<option>{{ lang('Create event') }}</option>
																	{% else %}
																		<option>{{ lang('- Created -') }}</option>
																	{% endif %}
																</select>
															</div>
														{% endif %}
													{% endfor %}
												</div>
											</div>
										</div>
									</div>

									<div class="app-panel app-panel-default">
										<div class="app-panel-heading" role="tab" id="headingSeven">
											<h4 class="app-panel-title">
												<a class="" role="button" data-bs-toggle="collapse" data-parent="#accordion" href="#collapseSeven" aria-expanded="true" aria-controls="collapseSeven">{{ lang('payments') }}</a>
											</h4>
										</div>
										<div id="collapseSeven" class="app-panel-collapse collapse show" role="tabpanel" aria-labelledby="headingSeven">
											<div class="app-panel-body">
												<div class="app-list-group-item flex-column align-items-start">
													<div id="payments_container"></div>
												</div>
												<div class="app-list-group-item flex-column align-items-start" id="order_details">
													<div class="d-flex w-100 justify-content-between">
														<h5 class="mb-1">{{ lang('details') }}</h5>
													</div>
													<div id="order_container"></div>
												</div>
											</div>
										</div>
									</div>

									<div class="app-panel app-panel-default">
										<div class="app-panel-heading" role="tab" id="headingNine">
											<h4 class="app-panel-title">
												<a class="" role="button" data-bs-toggle="collapse" data-parent="#accordion" href="#collapseNine" aria-expanded="true" aria-controls="collapseNine">{{ lang('Associated items') }}</a>
											</h4>
										</div>
										<div id="collapseNine" class="app-panel-collapse collapse show" role="tabpanel" aria-labelledby="headingNine">
											<div class="app-panel-body">
												<div id="associated_container"></div>
											</div>
										</div>
									</div>
									<div class="app-panel app-panel-default">
										<div class="app-panel-heading" role="tab" id="headingTen">
											<h4 class="app-panel-title">
												<a class="" role="button" data-bs-toggle="collapse" data-parent="#accordion" href="#collapseTen" aria-expanded="true" aria-controls="collapseTen">{{ lang('attachments') }}</a>
											</h4>
										</div>
										<div id="collapseTen" class="app-panel-collapse collapse show" role="tabpanel" aria-labelledby="headingTen">
											<div class="app-panel-body">
												<div id="attachments_container"></div>
												<br/>
												<form method="POST" enctype='multipart/form-data' id='file_form'>
													<input name="name" id='field_name' type='file' title="{{ document.name|default('') }}" data-validation="mime size" data-validation-allowing="jpg, jpeg, png, gif, xls, xlsx, doc, docx, txt, pdf, odt, ods" data-validation-max-size="2M" data-validation-error-msg="Max 2M:: jpg, jpeg, png, gif, xls, xlsx, doc, docx, txt , pdf, odt, ods" />
													<br/>
													<br/>
													<input type="submit" value="{{ lang('Add attachment') }}" class="app-button app-button-primary" />
												</form>
											</div>
										</div>
									</div>
									<div class="app-panel app-panel-default">
										<div class="app-panel-heading" role="tab" id="headingEleven">
											<h4 class="app-panel-title">
												<a class="" role="button" data-bs-toggle="collapse" data-parent="#accordion" href="#collapseEleven" aria-expanded="true" aria-controls="collapseEleven">{{ lang('Terms and conditions') }}</a>
											</h4>
										</div>
										<div id="collapseEleven" class="app-panel-collapse collapse show" role="tabpanel" aria-labelledby="headingEleven">
											<div class="app-panel-body">
												<div class="pure-control-group">
													{% if config.application_terms %}
														<p>{{ config.application_terms }}</p>
													{% endif %}
													<br />
													<div id='regulation_documents'>&nbsp;</div>
													<br />
													<p>{{ lang('To borrow premises you must verify that you have read terms and conditions') }}</p>
												</div>
											</div>
											<div class="app-panel-body">
												<h4>{{ lang('additional requirements') }}</h4>
												{{ application.agreement_requirements|raw }}
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="tab-pane fade" id="internal_notes">
			{% set date_format = get_phpgw_info('user|preferences|common|dateformat') %}
			<h3>{{ lang('internal notes') }}</h3>

			{% for note in internal_notes %}
				<div class="app-panel-body">
					<div class="app-list-group">
						<div class="app-list-group-item flex-column align-items-start">
							<div class="d-flex w-100 justify-content-between">
								<h5 class="mb-1">{{ note.datetime|date(date_format) }}</h5>
								<small class="text-body-secondary">{{ note.owner }}</small>
							</div>
							<p class="mb-1 font-weight-bold">{{ note.new_value|raw }}</p>
							<small class="text-body-secondary"></small>
						</div>
					</div>
				</div>
			{% endfor %}
		</div>

		<div class="tab-pane fade" id="history">
			<h3>{{ lang('History and comments (%1)', application.comments|length) }}</h3>

			{% for comment in application.comments|default([]) %}
				{% if comment.author %}
					<div class="app-panel-body">
						<div class="app-list-group">
							<div class="app-list-group-item flex-column align-items-start">
								<div class="d-flex w-100 justify-content-between">
									<h5 class="mb-1">{{ pretty_timestamp(comment.time) }}</h5>
									<small class="text-body-secondary">{{ comment.author }}</small>
								</div>
								<p class="mb-1 font-weight-bold">{{ comment.comment|raw }}</p>
								<small class="text-body-secondary"></small>
							</div>
						</div>
					</div>
				{% endif %}
			{% endfor %}
		</div>
	</div>
</div>

<script type="text/javascript">
	var template_set = '{{ get_phpgw_info('user|preferences|common|template_set')|e('js') }}';
	var date_format = '{{ get_phpgw_info('user|preferences|common|dateformat')|e('js') }}';
	var initialSelection = {{ application.resources_json|raw }};
	var application_id = '{{ application.id|e('js') }}';
	var resourceIds = '{{ application.resource_ids|e('js') }}';
	var currentuser = '{{ application.currentuser ? 1 : 0 }}';
	if (!resourceIds || resourceIds == "") {
		resourceIds = false;
	}
	var lang = {{ js_lang('Resources', 'Resource Type', 'No records found', 'ID', 'Type', 'From', 'To', 'Document', 'Active' ,'Delete', 'del', 'Name', 'Cost', 'order id', 'unit cost', 'Amount', 'currency', 'status', 'payment method', 'refund','refunded', 'Actions', 'cancel', 'created', 'article', 'Select', 'cost', 'unit', 'quantity', 'Selected', 'Delete', 'Sum', 'tax')|raw }};
	var app_id = {{ application.id }};
	var building_id = {{ application.building_id }};
	var resources = {{ application.resources|json_encode|raw }};

	var resourcesURL = phpGWLink('index.php', {menuaction:'booking.uiresource.index', sort:'name', length:-1}, true) +'&' + resourceIds;
	var associatedURL = phpGWLink('index.php', {menuaction:'booking.uiapplication.associated', sort:'from_',dir:'asc',filter_application_id:app_id, length:-1}, true);
	var documentsURL = phpGWLink('index.php', {menuaction:'booking.uidocument_view.regulations', sort:'name', length:-1}, true) +'&owner[]=building::' + building_id;
	var attachmentsResourceURL = phpGWLink('index.php', {menuaction:'booking.uidocument_application.index', sort:'name', no_images:1, filter_owner_id:app_id, length:-1}, true);
	var paymentURL = phpGWLink('index.php', {menuaction:'booking.uiapplication.payments', sort:'order_id',dir:'asc',application_id:app_id, length:-1}, true);
	var articlesURL = phpGWLink('index.php', {menuaction:'booking.uiapplication.articles', sort:'id',dir:'asc',application_id:app_id, length:-1}, true);

	for (var i = 0; i < initialSelection.length; i++)
	{
		documentsURL += '&owner[]=resource::' + initialSelection[i];
	}

	var colDefsResources = [{key: 'name', label: lang['Resources'], formatter: genericLink}, {key: 'rescategory_name', label: lang['Resource Type']}];

	if (currentuser == 1) {
		var colDefsAssociated = [
			{key: 'id', label: lang['ID'], formatter: genericLink},
			{key: 'type', label: lang['Type']},
			{key: 'from_', label: lang['From']},
			{key: 'to_', label: lang['To']},
			{key: 'cost', label: lang['Cost']},
			{key: 'active', label: lang['Active']},
			{key: 'dellink', label: lang['Delete'], formatter: genericLink2}
		];
	} else {
		var colDefsAssociated = [
			{key: 'id', label: lang['ID'], formatter: genericLink},
			{key: 'type', label: lang['Type']},
			{key: 'from_', label: lang['From']},
			{key: 'to_', label: lang['To']},
			{key: 'active', label: lang['Active']}
		];
	}

	var colDefsDocuments = [{key: 'name', label: lang['Document'], formatter: genericLink}];

	createTable('associated_container',associatedURL,colDefsAssociated,'results', 'pure-table pure-table-bordered');
	createTable('regulation_documents',documentsURL,colDefsDocuments, '', 'pure-table pure-table-bordered');

	if (currentuser == 1)
	{
		var colDefsAttachmentsResource = [
			{key: 'name', label: lang['Name'], formatter: genericLink},
			{key: 'option_delete', label: lang['Delete'], formatter: genericLink2}
		];
	}
	else
	{
		var colDefsAttachmentsResource = [{key: 'name', label: lang['Name'], formatter: genericLink}];
	}

	createTable('attachments_container', attachmentsResourceURL, colDefsAttachmentsResource, '', 'pure-table pure-table-bordered');

	var colDefsArticles = [
		{key: 'article', label: lang['article']},
		{key: 'quantity', label: lang['quantity']},
		{key: 'unit', label: lang['unit']},
		{key: 'cost', label: lang['cost']},
		{key: 'currency', label: lang['currency']}
	];
	createTable('articles_container', articlesURL, colDefsArticles, '', 'pure-table pure-table-bordered');

	var colDefsPayment = [
		{
			label: lang['Select'],
			attrs: [{name: 'class', value: "align-middle"}],
			object: [
				{
					type: 'input',
					attrs: [
						{name: 'type', value: 'radio'},
						{name: 'name', value: 'order_selector'},
						{name: 'class', value: 'order_selector'},
						{name: 'onClick', value: 'show_order(this);'}
					]
				}
			], value: 'order_id'
		},
		{key: 'order_id', label: lang['order id']},
		{key: 'created_value', label: lang['created']},
		{key: 'amount', label: lang['Amount']},
		{key: 'refunded_amount', label: lang['refunded']},
		{key: 'currency', label: lang['currency']},
		{key: 'status_text', label: lang['status']},
		{key: 'payment_method', label: lang['payment method']},
		{key: 'actions', label: lang['Actions'], formatter: genericLink2({name: 'delete', label: lang['refund']}, {name: 'edit', label: lang['cancel']})}
	];

	createTable('payments_container', paymentURL, colDefsPayment,'', 'pure-table pure-table-bordered');
</script>

<div class="app-modal" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel" aria-hidden="true">
	<div class="app-modal-dialog app-modal-lg app-modal-dialog-centered" role="document">
		<div class="app-modal-content">
			<div class="app-modal-header">
				<h5 class="app-modal-title" id="commentModalLabel">{{ lang('Add a comment') }}</h5>
				<button class="app-button-close" type="button" data-bs-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">x</span>
				</button>
			</div>
			<div class="app-modal-body">
				{% if application.edit_link %}
					<div class="pure-u-1">
						<form method="POST">
							<div class="pure-control-group">
								<label for="comment"></label>
								<textarea name="comment" id="comment" required="required"></textarea>
								<br/>
							</div>
							<div class="pure-control-group">
								<label>&nbsp;</label>
								<input type="submit" value="{{ lang('Add comment') }}" class="pure-button pure-button-primary" />
							</div>
						</form>
						<br/>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<div class="app-modal" id="messengerModal" tabindex="-1" role="dialog" aria-labelledby="messengerModalLabel" aria-hidden="true">
	<div class="app-modal-dialog app-modal-lg app-modal-dialog-centered" role="document">
		<div class="app-modal-content">
			<div class="app-modal-header">
				<h5 class="app-modal-title" id="messengerModalLabel">{{ lang('Add message') }} ({{ case_officer_display_name }})</h5>
				<button class="app-button-close" type="button" data-bs-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">x</span>
				</button>
			</div>
			<form method="POST">
				<div class="app-modal-body">
					{% if application.edit_link %}
						<div class="form-group">
							<label for="message_subject">{{ lang('Subject') }}</label>
							<input type="hidden" name="message_recipient" value="{{ application.case_officer_id }}" />
							<input type="text" name="message_subject" id="message_subject" required="required" class="app-input" value="{{ lang('application') }} #{{ application.id }} - {{ application.building_name }}" />
							<label for="message_content">{{ lang('content') }}</label>
							<textarea name="message_content" id="message_content" required="required" class="app-input"></textarea>
						</div>
					{% endif %}
				</div>
				<div class="app-modal-footer">
					<button type="submit" class="app-button app-button--primary">{{ lang('save') }}</button>
					<button type="button" class="app-button app-button--secondary" data-bs-dismiss="modal">{{ lang('cancel') }}</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div class="app-modal" id="change_userModal" tabindex="-1" role="dialog" aria-labelledby="change_userModalLabel" aria-hidden="true">
	<div class="app-modal-dialog app-modal-lg app-modal-dialog-centered" role="document">
		<div class="app-modal-content">
			<div class="app-modal-header">
				<h5 class="app-modal-title" id="change_userModalLabel">{{ lang('case officer') }}</h5>
				<button class="app-button-close" type="button" data-bs-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">x</span>
				</button>
			</div>
			<form method="POST">
				<div class="app-modal-body">
					{% if application.edit_link %}
						<div class="form-group">
							<select name="assign_to_new_user" id="new_case_officer" required="required" class="app-input" aria-describedby="case_officer_help">
								<option value="0">{{ lang('select') }}</option>
								{% for option in user_list.options %}
									<option value="{{ option.id }}" {% if option.selected|default(0) != 0 %}selected="selected"{% endif %}>{{ option.name|raw }}</option>
								{% endfor %}
							</select>
							<small id="case_officer_help" class="form-text text-body-secondary">velg ny saksbehandler</small>
						</div>
					{% endif %}
				</div>
				<div class="app-modal-footer">
					<button type="submit" class="app-button app-button--primary">{{ lang('save') }}</button>
					<button type="button" class="app-button app-button--secondary" data-bs-dismiss="modal">{{ lang('cancel') }}</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div class="app-modal" id="internal_noteModal" tabindex="-1" role="dialog" aria-labelledby="internal_noteModalLabel" aria-hidden="true">
	<div class="app-modal-dialog app-modal-lg app-modal-dialog-centered" role="document">
		<div class="app-modal-content">
			<div class="app-modal-header">
				<h5 class="app-modal-title" id="internal_noteModalLabel">{{ lang('internal notes') }}</h5>
				<button class="app-button-close" type="button" data-bs-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">x</span>
				</button>
			</div>
			<form method="POST">
				<div class="app-modal-body">
					{% if application.edit_link %}
						<div class="form-group">
							<label for="internal_note_content">{{ lang('content') }}</label>
							<textarea name="internal_note_content" id="internal_note_content" required="required" class="app-input"></textarea>
						</div>
					{% endif %}
				</div>
				<div class="app-modal-footer">
					<button type="submit" class="app-button app-button--primary">{{ lang('save') }}</button>
					<button type="button" class="app-button app-button--secondary" data-bs-dismiss="modal">{{ lang('cancel') }}</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div class="app-modal" id="acceptApplicationModal" tabindex="-1" role="dialog" aria-labelledby="acceptApplicationModalLabel" aria-hidden="true">
	<div class="app-modal-dialog app-modal-dialog-centered" role="document">
		<div class="app-modal-content">
			<div class="app-modal-header">
				<h5 class="app-modal-title" id="acceptApplicationModalLabel">{{ lang('confirm_application_approval') }}</h5>
				<button class="app-button-close" type="button" data-bs-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">x</span>
				</button>
			</div>
			<form method="POST">
				<div class="app-modal-body">
					<p>{{ lang('approval_description') }}</p>
					<div class="form-group">
						<h5>{{ lang('comment_to_organizer') }}</h5>
						<textarea name="acceptance_message" id="acceptance_message" class="app-input" rows="4" placeholder="{{ lang('comment_placeholder') }}"></textarea>
					</div>
					<div class="form-group form-check">
						<input type="checkbox" class="app-checkbox" id="send_acceptance_email" name="send_acceptance_email" value="1" checked="checked" />
						<label class="app-label" for="send_acceptance_email">{{ lang('send_email_organizer_summary') }}</label>
					</div>
					<input type="hidden" name="status" value="ACCEPTED" />
				</div>
				<div class="app-modal-footer">
					<button type="button" class="app-button app-button--secondary" data-bs-dismiss="modal">{{ lang('Cancel') }}</button>
					<button type="submit" class="app-button app-button--success">{{ lang('Approve') }}</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div class="app-modal" id="rejectApplicationModal" tabindex="-1" role="dialog" aria-labelledby="rejectApplicationModalLabel" aria-hidden="true">
	<div class="app-modal-dialog app-modal-dialog-centered" role="document">
		<div class="app-modal-content">
			<div class="app-modal-header">
				<h5 class="app-modal-title" id="rejectApplicationModalLabel">{{ lang('Reject Application') }}</h5>
				<button class="app-button-close" type="button" data-bs-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">x</span>
				</button>
			</div>
			<form method="POST">
				<div class="app-modal-body">
					<p>{{ lang('Are you sure you want to delete?') }}</p>
					<div class="form-group">
						<label for="rejection_reason">{{ lang('Reason for rejection') }}</label>
						<textarea name="rejection_reason" id="rejection_reason" class="app-input" rows="4"></textarea>
					</div>
					<div class="form-group form-check">
						<input type="checkbox" class="app-checkbox" id="send_rejection_email" name="send_rejection_email" value="1" checked="checked" />
						<label class="app-label" for="send_rejection_email">{{ lang('send_email_to_applicant') }}</label>
					</div>
					<input type="hidden" name="status" value="REJECTED" />
				</div>
				<div class="app-modal-footer">
					<button type="button" class="app-button app-button--secondary" data-bs-dismiss="modal">{{ lang('Cancel') }}</button>
					<button type="submit" class="app-button app-button--danger">{{ lang('reject application') }}</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script>
	$(document).ready(function() {
		$('#new_case_officer').select2({
			dropdownParent: $('#change_userModal'),
			width: '90%'
		});

		$('#new_case_officer').on('select2:open', function (e) {
			$(".select2-search__field").each(function() {
				if ($(this).attr("aria-controls") == 'select2-new_case_officer-results')
				{
					$(this)[0].focus();
				}
			});
		});
	});
</script>

{% if show_edit_selection == 1 %}
	<div class="app-modal" id="editSelectionModal" tabindex="-1" role="dialog" aria-labelledby="editSelectionModalLabel" aria-hidden="true">
		<div class="app-modal-dialog app-modal-lg" role="document">
			<div class="app-modal-content">
				<div class="app-modal-header">
					<h5 class="app-modal-title" id="editSelectionModalLabel">
						<i class="fas fa-edit me-2"></i>Select Application to Edit
					</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">×</span>
					</button>
				</div>
				<div class="app-modal-body">
					<p class="text-muted mb-4">
						This combined application contains {{ related_applications|length }} related applications.
						Choose which one you want to edit:
					</p>

					<div class="app-row">
						{% for related in related_applications %}
							<div class="app-col-6 mb-3">
								<div class="app-card application-selection-card{% if related.is_main == 1 %} border-danger{% endif %}">
									<div class="app-card-body">
										<div class="d-flex justify-content-between align-items-start mb-2">
											<h6 class="app-card-title mb-0">
												{{ related.name }}
												{% if related.is_main == 1 %}
													<span class="app-badge app-badge-danger ml-2">MAIN</span>
												{% endif %}
											</h6>
											<span class="app-badge app-badge-{{ related.status == 'NEW' ? 'primary' : (related.status == 'PENDING' ? 'warning' : (related.status == 'ACCEPTED' ? 'success' : (related.status == 'REJECTED' ? 'danger' : 'secondary'))) }}">{{ related.status }}</span>
										</div>

										<small class="text-muted">
											<strong>ID:</strong> {{ related.id }}<br/>
											<strong>Created:</strong> {{ related.created }}<br/>
											{% if related.dates != '' %}<strong>Dates:</strong> {{ related.dates }}<br/>{% endif %}
											{% if related.resources != '' %}<strong>Resources:</strong> {{ related.resources }}{% endif %}
										</small>

										<a class="app-button app-button-primary app-button-sm mt-2" href="{{ application.edit_link }}&selected_app_id={{ related.id }}">
											<i class="fas fa-edit me-1"></i>Edit This Application
										</a>
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
				</div>
				<div class="app-modal-footer">
					<button type="button" class="app-button app-button--secondary" data-dismiss="modal">
						<i class="fas fa-times me-1"></i>Cancel
					</button>
				</div>
			</div>
		</div>
	</div>

	<style>
		.application-selection-card {
			transition: transform 0.2s, box-shadow 0.2s;
			cursor: pointer;
		}
		.application-selection-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		}
	</style>
{% endif %}
