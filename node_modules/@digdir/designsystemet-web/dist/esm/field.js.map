{"version":3,"file":"field.js","names":[],"sources":["../../src/field.ts"],"sourcesContent":["import {\r\n  attr,\r\n  customElements,\r\n  DSElement,\r\n  debounce,\r\n  isBrowser,\r\n  off,\r\n  on,\r\n  onHotReload,\r\n  onMutation,\r\n  QUICK_EVENT,\r\n  tag,\r\n  useId,\r\n  isWindows,\r\n} from './utils';\r\n\r\ndeclare global {\r\n  interface HTMLElementTagNameMap {\r\n    'ds-field': DSFieldElement;\r\n  }\r\n}\r\n\r\nconst CSS_FIELD_SIZE = '--_ds-field-sizing';\r\nconst ATTR_COUNTER_TEXT = 'data-counter-text';\r\nconst ATTR_COUNTER_ARIA = 'data-counter-aria';\r\nconst ATTR_FIELD = 'data-field';\r\nconst TYPE_DESCRIPTION = 'description';\r\nconst TYPE_VALIDATION = 'validation';\r\nconst COUNTER_DEBOUNCE = isWindows() ? 800 : 200; // Longer debounce on Windows due to NVDA performance\r\nconst COUNTER_TEXT = {\r\n  over: '%d tegn for mye',\r\n  under: '%d tegn for mye',\r\n  hint: 'Maks %d tegn tillatt.',\r\n};\r\n\r\nconst SELECTOR_FIELDSET_DESCRIPTION = `:scope > [${ATTR_FIELD}=\"${TYPE_DESCRIPTION}\"],:scope > legend + p`; // legend + p is kept for backwards compatibility\r\nconst SELECTOR_FIELDSET_VALIDATION = `:scope > [${ATTR_FIELD}=\"${TYPE_VALIDATION}\"]`;\r\nconst SELECTOR_FIELD_COUNTER = '[data-field=\"counter\"]';\r\n\r\nconst FIELDS = new Set<DSFieldElement>();\r\nconst FILEDSETS = isBrowser() ? document.getElementsByTagName('fieldset') : [];\r\nconst STYLE_SR_ONLY = `position:absolute;clip:rect(0 0 0 0);overflow:hidden;width:1px;height:1px;white-space:nowrap;pointer-events:none`;\r\n\r\n// TODO: Document that Validation must be hidden with \"hidden\" attribute (or completely removed from DOM), not display: none\r\nconst handleMutations = debounce(() => {\r\n  setupFieldsets();\r\n  setupFields();\r\n}, 100); // Debounce to avoid excessive calculations on multiple mutations\r\n\r\n// Connect fieldset legend and descriptions\r\nconst setupFieldsets = () => {\r\n  for (const fieldset of FILEDSETS) {\r\n    const labelledby = [\r\n      fieldset.querySelector('legend'),\r\n      fieldset.querySelector(SELECTOR_FIELDSET_DESCRIPTION),\r\n    ].filter(isNotHidden);\r\n\r\n    attr(fieldset, 'aria-labelledby', labelledby.map(useId).join(' '));\r\n  }\r\n};\r\n\r\nconst setupFields = () => {\r\n  for (const field of FIELDS) {\r\n    const descs: Element[] = [];\r\n    const labels: HTMLLabelElement[] = [];\r\n    let input: HTMLInputElement | undefined;\r\n\r\n    for (const el of field.getElementsByTagName('*')) {\r\n      if (el instanceof HTMLLabelElement) labels.push(el);\r\n      else if (isInputLike(el)) {\r\n        if (input)\r\n          console.warn(\r\n            `Designsystemet: Fields should only have one input element. Use <fieldset> to group multiple fields:`,\r\n            field,\r\n          );\r\n        input = el;\r\n      } else if (isNotHidden(el)) {\r\n        const type = el.getAttribute(ATTR_FIELD); // Using getAttribute not attr for best performance\r\n        if (type === TYPE_VALIDATION) descs.unshift(el);\r\n        else if (type) descs.push(el);\r\n      }\r\n    }\r\n\r\n    if (!input)\r\n      console.warn(`Designsystemet: Field is missing input element:`, field);\r\n    else {\r\n      for (const label of labels) attr(label, 'for', useId(input));\r\n\r\n      const isBoolish = input.type === 'radio' || input.type === 'checkbox';\r\n      const fieldsetValidation = field\r\n        .closest('fieldset')\r\n        ?.querySelector(SELECTOR_FIELDSET_VALIDATION);\r\n      if (isNotHidden(fieldsetValidation)) descs.unshift(fieldsetValidation);\r\n\r\n      field.handleEvent({ target: input }); // Run counter and textrarea resize\r\n      attr(field, 'data-clickdelegatefor', isBoolish ? useId(input) : null); // Expand click area to ds-field if radio/checkbox\r\n      attr(input, 'aria-describedby', descs.map(useId).join(' '));\r\n      attr(input, 'aria-invalid', `${descs.some(isInvalid)}`);\r\n    }\r\n  }\r\n};\r\n\r\nconst getCounterText = (el: Element, key: keyof typeof COUNTER_TEXT, num: number) =>\r\n  (attr(el, `data-${key}`) || COUNTER_TEXT[key]).replace('%d', `${Math.abs(num)}`);\r\n\r\nconst setupCounter = (field: DSFieldElement, target: EventTarget | null) => {\r\n  const el =\r\n    isInputLike(target) &&\r\n    field.querySelector<HTMLElement>(SELECTOR_FIELD_COUNTER);\r\n\r\n  if (el) {\r\n    const live = field.shadowRoot?.lastElementChild as HTMLElement;\r\n    const limit = Number(attr(el, 'data-limit')) || 0;\r\n    const count = limit - target.value.length;\r\n    const text = getCounterText(el, count < 0 ? 'over' : 'under', count);\r\n\r\n    attr(el, ATTR_COUNTER_TEXT, text);\r\n    attr(el, ATTR_COUNTER_ARIA, getCounterText(el, 'hint', limit));\r\n    attr(el, 'data-color', count < 0 ? 'danger' : null);\r\n    setupCounterLiveRegion(live, text); // Debounce live region to avoid NVDA interupting announcing typed text\r\n  }\r\n};\r\n\r\nconst setupCounterLiveRegion = debounce((live: Element, text: string) => {\r\n  live.textContent = text;\r\n}, COUNTER_DEBOUNCE);\r\n\r\n// iOS does not support field-sizing: content, so we need to manually resize\r\nconst setupTextareaFieldSizingiOS = (target: EventTarget | null) => {\r\n  if (target instanceof HTMLTextAreaElement) {\r\n    target.style.setProperty(CSS_FIELD_SIZE, 'auto');\r\n    target.style.setProperty(CSS_FIELD_SIZE, `${target.scrollHeight}px`);\r\n  }\r\n};\r\n\r\nconst isInputLike = (el: unknown): el is HTMLInputElement =>\r\n  el instanceof HTMLElement &&\r\n  'validity' in el && // Adds support for custom elements implemeted with attachInternals()\r\n  !(el instanceof HTMLButtonElement); // But skip <button> elements\r\n\r\nconst isNotHidden = (el?: Element | null): el is Element =>\r\n  !!el && !(el as HTMLElement).hidden;\r\n\r\nconst isInvalid = (el: Element): boolean =>\r\n  el.getAttribute(ATTR_FIELD) === TYPE_VALIDATION &&\r\n  attr(el, 'data-color') !== 'success';\r\n\r\n// Custom element is used to performantly keep track of fields on the page\r\nexport class DSFieldElement extends DSElement {\r\n  constructor() {\r\n    super();\r\n    this.attachShadow({ mode: 'open' }).append(\r\n      tag('slot'),\r\n      tag('div', { 'aria-live': 'polite', style: STYLE_SR_ONLY }), // Used to announce counter updates\r\n    );\r\n  }\r\n  connectedCallback() {\r\n    FIELDS.add(this);\r\n    on(this, 'input', this, QUICK_EVENT);\r\n    handleMutations(); // Initial setup\r\n  }\r\n  handleEvent({ target }: { target: EventTarget | null }) {\r\n    setupCounter(this, target);\r\n    setupTextareaFieldSizingiOS(target);\r\n  }\r\n  disconnectedCallback() {\r\n    off(this, 'input', this, QUICK_EVENT);\r\n    FIELDS.delete(this);\r\n  }\r\n}\r\n\r\ncustomElements.define('ds-field', DSFieldElement);\r\n\r\nonHotReload('field', () => [\r\n  onMutation(document, handleMutations, {\r\n    debounce: false, // No need to timeout debounce here as we handle it ourselves\r\n    attributeFilter: ['hidden', ATTR_FIELD], // Listen for hidden to detect hidden validations\r\n    attributes: true,\r\n    childList: true,\r\n    subtree: true,\r\n  }),\r\n]);\r\n"],"mappings":"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"}