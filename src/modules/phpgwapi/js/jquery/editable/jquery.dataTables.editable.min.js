!function(e){e.fn.makeEditable=function(t){var o,n,a,l,s,d,r,u,c,p,f,w,h;function m(e){var t=o.api().row(e).index();return o.api().rows(t).data()[0].id}function b(t){if(!r.bDisableEditing){var n={tooltip:"DoubleClick to edit",placeholder:"...",event:"dblclick",onsubmit:function(t,o){if(u=o.revert,c=null,sNewCellDisplayValue=null,y(),"text"==t.type||"select"==t.type||"textarea"==t.type){var n=e("input,select,textarea",this);if(c=e("input,select,textarea",e(this)).val(),1==n.length){var a=n[0];"select"==a.nodeName.toLowerCase()||"select"==a.tagName.toLowerCase()?sNewCellDisplayValue=e("option:selected",a).text():sNewCellDisplayValue=c}if(!r.fnOnEditing(n,t,o.revert,m(o)))return!1;return null!=t.oValidationOptions&&n.parents("form").validate(t.oValidationOptions),null!=t.cssclass&&n.addClass(t.cssclass),null==t.cssclass&&null==t.oValidationOptions||!(!n.valid()||0==n.valid())}r.fnStartProcessingMode()},submitdata:function(t,n){var a=o.api().row(this).index(),l=o.api().cell(this).index().column,s=o.api().cell(this).index().column,i=m(this),d=o.api().settings()[0].aoColumns[s].sName;null!=d&&""!=d||(d=o.api().settings()[0].aoColumns[s].sTitle);return null==r.aoColumns||null==r.aoColumns[s]?e.extend({},r.oUpdateParameters,{id:i,rowId:a,columnPosition:l,columnId:s,columnName:d}):e.extend({},r.oUpdateParameters,r.aoColumns[s].oUpdateParameters,{id:i,rowId:a,columnPosition:l,columnId:s,columnName:d})},callback:function(t,n){r.fnEndProcessingMode();var a="",l=o.api().row(this).index(),s=o.api().cell(this).index().column,i=[l,s,s];h.oFeatures.bServerSide;if(e("td.last-updated-cell",o.api().rows().nodes()).removeClass("last-updated-cell"),t.indexOf(r.sFailureResponsePrefix)>-1?(o.api().cell(this).data(u),e("td.last-updated-cell",o).removeClass("last-updated-cell"),e(this).addClass("last-updated-cell"),r.fnShowError(t.replace(r.sFailureResponsePrefix,"").trim(),"update"),a="failure"):"IGNORE"==r.sSuccessResponse||null!=r.aoColumns&&null!=r.aoColumns[i[2]]&&"IGNORE"==r.aoColumns[i[2]].sSuccessResponse||null==c||c==t||r.sSuccessResponse==t?(null==sNewCellDisplayValue?o.api().cell(this).data(t):o.api().cell(this).data(sNewCellDisplayValue),e("td.last-updated-cell",o).removeClass("last-updated-cell"),e(this).addClass("last-updated-cell"),a="success"):(o.api().cell(this).data(u),r.fnShowError(t,"update"),a="failure"),r.fnOnEdited(a,u,sNewCellDisplayValue,i[0],i[1],i[2]),null!=n.fnOnCellUpdated&&n.fnOnCellUpdated(a,t,i[0],i[2],n),T(),r.bUseKeyTable){var d=o.keys;setTimeout(function(){d.block=!1},0)}},onerror:function(){r.fnEndProcessingMode(),r.fnShowError("Cell cannot be updated","update"),r.fnOnEdited("failure")},onreset:function(){if(r.bUseKeyTable){var e=o.keys;setTimeout(function(){e.block=!1},0)}},height:r.sEditorHeight,width:r.sEditorWidth},a=null;if(null!=r.aoColumns){for(var l=0,s=0;l<h.aoColumns.length;l++)if(h.aoColumns[l].bVisible){if(null==r.aoColumns[s]){s++;continue}a=e("td:nth-child("+(s+1)+")",t);var i;i=e.extend({},n,r.oEditableSettings,r.aoColumns[s]),s++;var d=r.sUpdateURL;try{null!=i.sUpdateURL&&(d=i.sUpdateURL)}catch(e){}a.each(function(){e(this).hasClass(r.sReadOnlyCellClass)||e(this).editable(d,i)})}}else(a=e("td:not(."+r.sReadOnlyCellClass+")",t)).editable(r.sUpdateURL,e.extend({},n,r.oEditableSettings))}}function C(t){if(r.fnOnAdding()&&d.valid())if(y(),r.fnStartProcessingMode(),r.bUseFormsPlugin)e(d).ajaxSubmit({dataType:"xml",success:function(e,t,o){-1!=o.responseText.toLowerCase().indexOf("error")?(r.fnEndProcessingMode(),r.fnShowError(o.responseText.replace("Error",""),"add"),r.fnOnAdded("failure")):R(o.responseText)},error:function(e){r.fnEndProcessingMode(),r.fnShowError(e.responseText,"add"),r.fnOnAdded("failure")}});else{var o=d.serialize();e.ajax({url:r.sAddURL,data:o,type:r.sAddHttpMethod,dataType:r.sAddDataType,success:R,error:function(e){r.fnEndProcessingMode(),r.fnShowError(e.responseText,"add"),r.fnOnAdded("failure")}})}t.stopPropagation(),t.preventDefault()}function R(t){if(r.fnEndProcessingMode(),r.fnOnNewRowPosted(t)){var n=o.api().settings()[0];if(!n.oFeatures.bServerSide){jQuery.data(d,"DT_RowId",t);var a,l=S(d);a=null!=n.aoColumns&&isNaN(parseInt(n.aoColumns[0].mDataProp))?o.fnAddData(rowData):o.fnAddData(l);var s=o.api().rows(a).nodes();r.fnSetRowID(e(s),t,!0),b(s),e("tr.last-added-row",o).removeClass("last-added-row"),e(s).addClass("last-added-row")}if(d.dialog("close"),e(d)[0].reset(),e(".error",e(d)).html(""),T(),r.fnOnAdded("success"),r.bUseKeyTable){var i=o.keys;setTimeout(function(){i.block=!1},0)}}}function g(t){e(d).validate().resetForm(),e(d)[0].reset(),e(".error",e(d)).html(""),e(".error",e(d)).hide(),d.dialog("close"),t.stopPropagation(),t.preventDefault()}function A(){r.bUseKeyTable||(null!=r.oDeleteRowButtonOptions?a.button("option","disabled",!0):a.attr("disabled","true"))}function O(t){var o=e(this).attr("href");null!=o&&""!=o||(o=r.sDeleteURL),t.preventDefault(),t.stopPropagation(),y(),f=e(this).parents("td")[0],jSelectedRow=e(this).parents("tr"),p=jSelectedRow[0],jSelectedRow.addClass(r.sSelectedRowClass);var n=m(f);r.fnOnDeleting(jSelectedRow,n,D)&&D(n,o)}function v(t){if(t.preventDefault(),t.stopPropagation(),y(),p=null,f=null,r.bUseKeyTable)f=e("td.focus",o)[0];else{if(0==e("tr."+r.sSelectedRowClass+" td",o).length)return void _fnDisableDeleteButton();f=e("tr."+r.sSelectedRowClass+" td",o)[0]}if(null!=f){r.bUseKeyTable&&(w=o.keys.fnGetCurrentPosition());var n=m(f),a=e(f).parent("tr");p=a[0],r.fnOnDeleting(a,n,D)&&D(n)}else A()}function D(t,o){var n=o;null==o&&(n=r.sDeleteURL),r.fnStartProcessingMode();var a=e.extend(r.oDeleteParameters,{id:t});e.ajax({url:n,type:r.sDeleteHttpMethod,data:a,success:N,dataType:r.sDeleteDataType,error:function(e){r.fnEndProcessingMode(),r.fnShowError(e.responseText,"delete"),r.fnOnDeleted("failure")}})}function N(e){r.fnEndProcessingMode();var t=p;e==r.sSuccessResponse||""==e?(o.fnDeleteRow(t),A(),T(),r.bUseKeyTable&&o.keys.fnSetPosition(w[0],w[1]),r.fnOnDeleted("success")):(r.fnShowError(e,"delete"),r.fnOnDeleted("failure"))}function y(){return h._iDisplayStart}function T(){o.api().draw("page")}function x(t,n){var a=o.api().row(n).index(),l=r.fnGetRowID(e(n));e(t).validate().resetForm(),jQuery.data(e(t)[0],"DT_RowId",l),e("input.DT_RowId",e(t)).val(l),jQuery.data(e(t)[0],"ROWID",a),e("input.ROWID",e(t)).val(a);var s=o.api().settings()[0].aoColumns.length;e("input:text[rel],input:radio[rel][checked],input:hidden[rel],select[rel],textarea[rel],input:checkbox[rel]",e(t)).each(function(){var t=e(this).attr("rel");if(t>=s)r.fnShowError("In the form is placed input element with the name '"+e(this).attr("name")+"' with the 'rel' attribute that must be less than a column count - "+s,"action");else{var a=o.api().rows(n)[0][t];if(console.log("sCellValue: "+a),"select"==this.nodeName.toLowerCase()||"select"==this.tagName.toLowerCase())if(1==this.multiple){var l=new Array;for(aoCellValues=a.split(","),i=0;i<=this.options.length-1;i++)-1!=jQuery.inArray(this.options[i].text.toLowerCase().trim(),aoCellValues)&&l.push(this.options[i].value);e(this).val(l)}else for(i=0;i<=this.options.length-1;i++)this.options[i].text.toLowerCase()==a.toLowerCase()&&e(this).val(this.options[i].value);else"span"==this.nodeName.toLowerCase()||"span"==this.tagName.toLowerCase()?e(this).html(a):"checkbox"==this.type?"true"==a&&e(this).attr("checked",!0):"radio"==this.type?this.value==a&&(this.checked=!0):this.value=a}})}function S(t){var o=jQuery.data(t,"DT_RowId"),n=h.aoColumns.length,a=new Array,l=new Object;return e("input:text[rel],input:radio[rel][checked],input:hidden[rel],select[rel],textarea[rel],span.datafield[rel],input:checkbox[rel]",t).each(function(){var t=e(this).attr("rel"),s="";t>=n?r.fnShowError("In the add form is placed input element with the name '"+e(this).attr("name")+"' with the 'rel' attribute that must be less than a column count - "+n,"add"):(s=(s=(s="select"==this.nodeName.toLowerCase()||"select"==this.tagName.toLowerCase()?e.map(e.makeArray(e("option:selected",this)),function(t,o){return e(t).text()}).join(","):"span"==this.nodeName.toLowerCase()||"span"==this.tagName.toLowerCase()?e(this).html():"checkbox"==this.type?this.checked?"on"!=this.value?this.value:"true":"on"!=this.value?"":"false":this.value).replace("DATAROWID",o)).replace(r.sIDToken,o),null!=h.aoColumns&&null!=h.aoColumns[t]&&isNaN(parseInt(h.aoColumns[0].mDataProp))?l[h.aoColumns[t].mDataProp]=s:a[t]=s)}),null!=h.aoColumns&&isNaN(parseInt(h.aoColumns[0].mDataProp))?l:a}function k(t){var o=e(t),n=o.attr("id");n=n.replace("form","");var a=o.attr("action");if(r.fnOnBeforeAction(n)&&o.valid())if(y(),r.fnStartProcessingMode(),r.bUseFormsPlugin){var l={success:function(e,o,a){r.fnEndProcessingMode(),-1!=e.toLowerCase().indexOf("error")||"success"!=o?(r.fnShowError(e,n),r.fnOnActionCompleted("failure")):(I(t),r.fnOnActionCompleted("success"))},error:function(e){r.fnEndProcessingMode(),r.fnShowError(e.responseText,n),r.fnOnActionCompleted("failure")}};(function(e){r.aoTableAction&&r.fnShowError("Configuration error - aoTableAction setting are not set",e);var t=0;for(t=0;t<r.aoTableActions.length;t++)if(r.aoTableActions[t].sAction==e)return r.aoTableActions[t];r.fnShowError("Cannot find action configuration settings",e)})(n);l=e.extend({},r.oAjaxSubmitOptions,l),e(oActionForm).ajaxSubmit(l)}else{var s=o.serialize();e.ajax({url:a,data:s,type:r.sAddHttpMethod,dataType:r.sAddDataType,success:function(e){r.fnEndProcessingMode(),I(t),r.fnOnActionCompleted("success")},error:function(e){r.fnEndProcessingMode(),r.fnShowError(e.responseText,n),r.fnOnActionCompleted("failure")}})}}function I(t){for(var n=S(t),a=(jQuery.data(t,"ROWID"),o.api().settings()[0]),l=a.aoColumns.length,s=0;s<l;s++)null!=a.aoColumns&&null!=a.aoColumns[s]&&isNaN(parseInt(a.aoColumns[0].mDataProp))?sCellValue=rowData[a.aoColumns[s].mDataProp]:sCellValue=n[s],null!=sCellValue&&(console.log("sCellValue: "+sCellValue),o.api().cell(this).data(sCellValue));T(),e(t).dialog("close")}o=this;var E={sUpdateURL:"UpdateData",sAddURL:"AddData",sDeleteURL:"DeleteData",sAddNewRowFormId:"formAddNewRow",oAddNewRowFormOptions:{autoOpen:!1,modal:!0},sAddNewRowButtonId:"btnAddNewRow",oAddNewRowButtonOptions:null,sAddNewRowOkButtonId:"btnAddNewRowOk",sAddNewRowCancelButtonId:"btnAddNewRowCancel",oAddNewRowOkButtonOptions:{label:"Ok"},oAddNewRowCancelButtonOptions:{label:"Cancel"},sDeleteRowButtonId:"btnDeleteRow",oDeleteRowButtonOptions:null,sSelectedRowClass:"row_selected",sReadOnlyCellClass:"read_only",sAddDeleteToolbarSelector:".add_delete_toolbar",fnShowError:function(e,t){alert(e)},fnStartProcessingMode:function(){o.api().settings()[0].oFeatures.bProcessing&&e(".dataTables_processing").css("visibility","visible")},fnEndProcessingMode:function(){o.api().settings()[0].oFeatures.bProcessing&&e(".dataTables_processing").css("visibility","hidden")},aoColumns:null,fnOnDeleting:function(e,t,o){return confirm("Are you sure that you want to delete this record?")},fnOnDeleted:function(e){},fnOnAdding:function(){return!0},fnOnNewRowPosted:function(e){return!0},fnOnAdded:function(e){},fnOnEditing:function(e){return!0},fnOnEdited:function(e,t,o,n,a,l){},sAddHttpMethod:"POST",sAddDataType:"text",sDeleteHttpMethod:"POST",sDeleteDataType:"text",fnGetRowID:function(e){return e.attr("id")},fnSetRowID:function(e,t,o){o?e.attr("id",t):null!=e.attr("id")&&""!=e.attr("id")||e.attr("id",t)},sEditorHeight:"100%",sEditorWidth:"100%",bDisableEditing:!1,oDeleteParameters:{},oUpdateParameters:{},sIDToken:"DT_RowId",aoTableActions:null,fnOnBeforeAction:function(e){return!0},bUseFormsPlugin:!1,fnOnActionCompleted:function(e){},sSuccessResponse:"ok",sFailureResponsePrefix:"ERROR",oKeyTable:null};return r=e.extend(E,t),h=o.api().settings()[0],r.bUseKeyTable=null!=r.oKeyTable,this.each(function(){var t=o.dataTableSettings[0].sTableId;if(r.bUseKeyTable){var i=new KeyTable({table:document.getElementById(t),datatable:o});o.keys=i,i.event.action(null,null,function(t){e(t).hasClass(r.sReadOnlyCellClass)||(i.block=!0,setTimeout(function(){e(t).dblclick()},0))})}if(null!=o.api().settings()[0].sAjaxSource?o.api().settings()[0].aoDrawCallback.push({fn:function(){b(o.api().rows().nodes()),e(o.api().rows().nodes()).each(function(){var t=o.api().row(this).index(),n=o.api().rows(t)[0][0];r.fnSetRowID(e(this),n)})},sName:"fnApplyEditable"}):b(o.api().rows().nodes()),0!=(d=e("#"+r.sAddNewRowFormId)).length){var u=o.api().settings()[0].aoColumns.length;for(p=0;p<u;p++)0==e("[rel="+p+"]",d).length&&r.fnShowError("In the form that is used for adding new records cannot be found an input element with rel="+p+" that will be bound to the value in the column "+p+". See http://code.google.com/p/jquery-datatables-editable/wiki/AddingNewRecords#Add_new_record_form for more details","init");if(null!=r.oAddNewRowFormOptions?r.oAddNewRowFormOptions.autoOpen=!1:r.oAddNewRowFormOptions={autoOpen:!1},d.dialog(r.oAddNewRowFormOptions),0!=(n=e("#"+r.sAddNewRowButtonId)).length)"true"!=n.data("add-event-attached")&&(n.click(function(){d.dialog("open")}),n.data("add-event-attached","true"));else{if(0==e(r.sAddDeleteToolbarSelector).length)throw"Cannot find a button with an id '"+r.sAddNewRowButtonId+"', or placeholder with an id '"+r.sAddDeleteToolbarSelector+"' that should be used for adding new row although form for adding new record is specified";n=null}"form"==d[0].nodeName.toLowerCase()?(d.unbind("submit"),d.submit(function(e){return C(e),!1})):(e("form",d[0]).unbind("submit"),e("form",d[0]).submit(function(e){return C(e),!1}));var c=[];0==(l=e("#"+r.sAddNewRowOkButtonId,d)).length?(null!=r.oAddNewRowOkButtonOptions.text&&""!=r.oAddNewRowOkButtonOptions.text||(r.oAddNewRowOkButtonOptions.text="Ok"),r.oAddNewRowOkButtonOptions.click=C,r.oAddNewRowOkButtonOptions.id=r.sAddNewRowOkButtonId,c.push(r.oAddNewRowOkButtonOptions)):l.click(C),0==(s=e("#"+r.sAddNewRowCancelButtonId)).length?(null!=r.oAddNewRowCancelButtonOptions.text&&""!=r.oAddNewRowCancelButtonOptions.text||(r.oAddNewRowCancelButtonOptions.text="Cancel"),r.oAddNewRowCancelButtonOptions.click=g,r.oAddNewRowCancelButtonOptions.id=r.sAddNewRowCancelButtonId,c.push(r.oAddNewRowCancelButtonOptions)):s.click(g),c.length>0&&d.dialog("option","buttons",c),l=e("#"+r.sAddNewRowOkButtonId),s=e("#"+r.sAddNewRowCancelButtonId),null!=r.oAddNewRowFormValidation&&d.validate(r.oAddNewRowFormValidation)}else d=null;if(0!=(a=e("#"+r.sDeleteRowButtonId)).length?"true"!=a.data("delete-event-attached")&&(a.click(v),a.data("delete-event-attached","true")):a=null,oAddDeleteToolbar=e(r.sAddDeleteToolbarSelector),0!=oAddDeleteToolbar.length&&(null==n&&""!=r.sAddNewRowButtonId&&null!=d&&(oAddDeleteToolbar.append("<button id='"+r.sAddNewRowButtonId+"' class='add_row'>Add</button>"),(n=e("#"+r.sAddNewRowButtonId)).click(function(){d.dialog("open")})),null==a&&""!=r.sDeleteRowButtonId&&(oAddDeleteToolbar.append("<button id='"+r.sDeleteRowButtonId+"' class='delete_row'>Delete</button>"),(a=e("#"+r.sDeleteRowButtonId)).click(v))),null!=a&&(null!=r.oDeleteRowButtonOptions&&a.button(r.oDeleteRowButtonOptions),A()),null!=n&&null!=r.oAddNewRowButtonOptions&&n.button(r.oAddNewRowButtonOptions),null!=l&&null!=r.oAddNewRowOkButtonOptions&&l.button(r.oAddNewRowOkButtonOptions),null!=s&&null!=r.oAddNewRowCancelButtonOptions&&s.button(r.oAddNewRowCancelButtonOptions),e(".table-action-deletelink",o).on("click",O),r.bUseKeyTable?o.keys.event.focus(null,null,function(e,t,o){}):e("tbody",o).click(function(t){e(t.target.parentNode).hasClass(r.sSelectedRowClass)?(e(t.target.parentNode).removeClass(r.sSelectedRowClass),null!=a&&A()):(e(o.api().settings()[0].aoData).each(function(){e(this.nTr).removeClass(r.sSelectedRowClass)}),e(t.target.parentNode).addClass(r.sSelectedRowClass),null!=a&&(null!=r.oDeleteRowButtonOptions?a.button("option","disabled",!1):a.removeAttr("disabled")))}),null!=r.aoTableActions)for(var p=0;p<r.aoTableActions.length;p++){var f=e.extend({sType:"edit"},r.aoTableActions[p]),w=f.sAction,h=(f.sActionFormId,e("#form"+w));if(0!=h.length){var m={autoOpen:!1,modal:!0};m=e.extend({},f.oFormOptions,m),h.dialog(m),h.data("action-options",f);var R=e(".table-action-"+w);0!=R.length&&R.on("click",function(){var t=this.className.split(/\s+/),o="",n="";for(p=0;p<t.length;p++)t[p].indexOf("table-action-")>-1&&(o="#form"+(n=t[p].replace("table-action-","")));if(""==o&&r.fnShowError("Cannot find a form with an id "+o+" that should be associated to the action - "+n,n),"edit"==e(o).data("action-options").sType){var a=e(this).parents("tr")[0];x(h,a)}e(h).dialog("open")}),h.submit(function(e){return k(this),!1});var D=new Array,N=e("#form"+w+"Cancel",h);0!=N.length&&(D.push(N),N.click(function(){var t=e(this).parents("form")[0];e(t).validate().resetForm(),e(t)[0].reset(),e(".error",e(t)).html(""),e(".error",e(t)).hide(),e(t).dialog("close")})),e("button",h).button()}}})}}(jQuery);