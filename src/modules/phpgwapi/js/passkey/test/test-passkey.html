<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passkey Development Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        input[type=text] {
            padding: 8px;
            margin: 5px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            width: 100%;
            max-width: 300px;
        }
        pre {
            background-color: #f0f0f0;
            padding: 10px;
            overflow-x: auto;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .info {
            background-color: #d9edf7;
            color: #31708f;
            border: 1px solid #bce8f1;
        }
        #logOutput {
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            background-color: #272822;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Passkey Development Tester</h1>
    
    <div class="section">
        <h2>Setup Virtual Authenticator</h2>
        <p>Before testing passkeys on a device without a fingerprint reader, you need to set up a virtual authenticator:</p>
        <ol>
            <li>Launch Chrome with the flag: <code>--enable-web-authentication-testing-api</code></li>
            <li>Click the button below to create a virtual authenticator</li>
        </ol>
        <button id="setupVirtualAuthBtn">Setup Virtual Authenticator</button>
        <div id="setupStatus" class="status"></div>
    </div>
        <!-- Add this to your test-passkey.html file right after the setup virtual authenticator section -->
    <div class="section">
        <h2>Alternative: Use Chrome DevTools</h2>
        <p>If the virtual authenticator setup fails, you can use Chrome's built-in WebAuthn simulator:</p>
        <ol>
            <li>Press F12 to open Chrome DevTools</li>
            <li>Click on the three-dot menu (⋮) in the DevTools panel</li>
            <li>Go to More tools → WebAuthn</li>
            <li>Click "Add virtual authenticator"</li>
            <li>Configure with these settings:
                <ul>
                    <li>Protocol: ctap2</li>
                    <li>Transport: internal</li>
                    <li>Check "Supports resident keys"</li>
                    <li>Check "Supports user verification"</li>
                </ul>
            </li>
            <li>Click "Add"</li>
        </ol>
        <p>After setting up the virtual authenticator through DevTools, you can use the passkey functions normally.</p>
    </div>
<!-- Add this to your test-passkey.html file -->
<div class="section">
    <h2>Test with Security Key + PIN</h2>
    <p>You can use a physical security key with a PIN for testing:</p>
    <ol>
        <li>Make sure your security key is connected to your computer</li>
        <li>Ensure you've set a PIN for your security key (in Chrome: <code>chrome://settings/securityKeys</code>)</li>
        <li>Click the button below to configure for security key testing</li>
    </ol>
    <button id="configureSecurityKeyBtn">Configure for Security Key Testing</button>
    <div id="securityKeyStatus" class="status"></div>
</div>
    <div class="section">
        <h2>Mock Server Configuration</h2>
        <p>This test environment uses in-memory storage to simulate server-side functionality.</p>
        <p>When using this with your real server endpoints, replace the URLs in the inputs below.</p>
    </div>

    <div class="section">
        <h2>Register Passkey</h2>
        <div>
            <label for="username">Username:</label>
            <input type="text" id="username" placeholder="Enter username" value="testuser">
        </div>
        <div>
            <label for="regOptionsUrl">Registration Options URL:</label>
            <input type="text" id="regOptionsUrl" placeholder="URL to fetch options" value="mock://registration-options">
        </div>
        <div>
            <label for="regVerifyUrl">Registration Verify URL:</label>
            <input type="text" id="regVerifyUrl" placeholder="URL to verify registration" value="mock://registration-verify">
        </div>
        <button id="registerBtn">Register Passkey</button>
        <div id="registerStatus" class="status"></div>
    </div>

    <div class="section">
        <h2>Authenticate with Passkey</h2>
        <div>
            <label for="authOptionsUrl">Authentication Options URL:</label>
            <input type="text" id="authOptionsUrl" placeholder="URL to fetch options" value="mock://authentication-options">
        </div>
        <div>
            <label for="authVerifyUrl">Authentication Verify URL:</label>
            <input type="text" id="authVerifyUrl" placeholder="URL to verify authentication" value="mock://authentication-verify">
        </div>
        <button id="authenticateBtn">Authenticate with Passkey</button>
        <div id="authenticateStatus" class="status"></div>
    </div>

    <div class="section">
        <h2>Console Log</h2>
        <button id="clearLogBtn">Clear Log</button>
        <div id="logOutput"></div>
    </div>

    <!-- Include the Passkey Client JS -->
    <script src="../passkey-client.js"></script>
    
    <!-- Mock server functionality for testing -->
    <script>
        // In-memory storage for the mock server
        const mockServer = {
            // Store registered credentials
            credentials: [],
            // Generate a random challenge
            generateChallenge: () => {
                const array = new Uint8Array(32);
                window.crypto.getRandomValues(array);
                return PasskeyUtils.arrayBufferToBase64url(array.buffer);
            },
            // Mock fetch for test URLs
            fetch: async (url, options) => {
                console.log(`Mock fetch: ${url}`, options);
                
                // Registration options endpoint
                if (url === 'mock://registration-options') {
                    // Create minimal registration options
                    const challenge = mockServer.generateChallenge();
                    return {
                        ok: true,
                        json: async () => ({
                            challenge: challenge,
                            timeout: 60000,
                        })
                    };
                }
                
                // Registration verification endpoint
                if (url === 'mock://registration-verify') {
                    const body = JSON.parse(options.body);
                    console.log("Registration verification received:", body);
                    
                    // Store the credential for later authentication
                    mockServer.credentials.push({
                        id: body.id,
                        rawId: body.rawId,
                        username: body.username
                    });
                    
                    return {
                        ok: true,
                        json: async () => ({ success: true })
                    };
                }
                
                // Authentication options endpoint
                if (url === 'mock://authentication-options') {
                    // Create minimal authentication options
                    const challenge = mockServer.generateChallenge();
                    
                    // Use previously registered credentials if available
                    const allowCredentials = mockServer.credentials.map(cred => ({
                        type: 'public-key',
                        id: cred.rawId,
                        transports: ['internal']
                    }));
                    
                    return {
                        ok: true,
                        json: async () => ({
                            challenge: challenge,
                            timeout: 60000,
                            allowCredentials: allowCredentials.length > 0 ? allowCredentials : undefined
                        })
                    };
                }
                
                // Authentication verification endpoint
                if (url === 'mock://authentication-verify') {
                    const body = JSON.parse(options.body);
                    console.log("Authentication verification received:", body);
                    
                    // Verify credential ID exists in our stored credentials
                    const validCred = mockServer.credentials.find(cred => cred.id === body.id);
                    
                    if (validCred) {
                        return {
                            ok: true,
                            json: async () => ({ 
                                success: true,
                                username: validCred.username
                            })
                        };
                    } else {
                        return {
                            ok: false,
                            json: async () => ({ 
                                success: false,
                                message: "Unknown credential"
                            })
                        };
                    }
                }
                
                // Use the real fetch for non-mock URLs
                const originalFetch = window._originalFetch || fetch;
                return originalFetch(url, options);
            }
        };
        
        // Store original fetch
        window._originalFetch = window.fetch;
        
        // Override fetch for testing
        window.fetch = mockServer.fetch;
    </script>
    
    <script>
        // Custom console logging to the UI
        const logOutput = document.getElementById('logOutput');
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };
        
        // Override console methods to log to UI
        console.log = function(...args) {
            originalConsole.log.apply(console, args);
            appendToLog('LOG', args);
        };
        
        console.error = function(...args) {
            originalConsole.error.apply(console, args);
            appendToLog('ERROR', args, 'red');
        };
        
        console.warn = function(...args) {
            originalConsole.warn.apply(console, args);
            appendToLog('WARN', args, 'orange');
        };
        
        function appendToLog(type, args, color = null) {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: gray">[${timestamp}]</span> <span style="color: ${color || 'inherit'}">[${type}]</span> ${args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ')}`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        // Setup event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const setupVirtualAuthBtn = document.getElementById('setupVirtualAuthBtn');
            const registerBtn = document.getElementById('registerBtn');
            const authenticateBtn = document.getElementById('authenticateBtn');
            const clearLogBtn = document.getElementById('clearLogBtn');
            
            // Setup Virtual Authenticator
            setupVirtualAuthBtn.addEventListener('click', async () => {
                const setupStatus = document.getElementById('setupStatus');
                setupStatus.className = 'status info';
                setupStatus.textContent = 'Setting up virtual authenticator...';
                
                try {
                    const result = await setupVirtualAuthenticator();
                    if (result) {
                        setupStatus.className = 'status success';
                        setupStatus.textContent = '✅ Virtual authenticator setup successfully. You can now register and use passkeys.';
                    } else {
                        setupStatus.className = 'status error';
                        setupStatus.textContent = '❌ Failed to set up virtual authenticator. Make sure you launched Chrome with the --enable-web-authentication-testing-api flag.';
                    }
                } catch (error) {
                    setupStatus.className = 'status error';
                    setupStatus.textContent = `❌ Error: ${error.message}`;
                }
            });
            
            // Register Passkey
            registerBtn.addEventListener('click', async () => {
                const username = document.getElementById('username').value;
                const regOptionsUrl = document.getElementById('regOptionsUrl').value;
                const regVerifyUrl = document.getElementById('regVerifyUrl').value;
                const registerStatus = document.getElementById('registerStatus');
                
                if (!username) {
                    registerStatus.className = 'status error';
                    registerStatus.textContent = 'Please enter a username.';
                    return;
                }
                
                registerStatus.className = 'status info';
                registerStatus.textContent = 'Registering passkey...';
                
                try {
                    const result = await registerPasskey(username, regOptionsUrl, regVerifyUrl);
                    if (result) {
                        registerStatus.className = 'status success';
                        registerStatus.textContent = '✅ Passkey registered successfully.';
                    } else {
                        registerStatus.className = 'status error';
                        registerStatus.textContent = '❌ Failed to register passkey.';
                    }
                } catch (error) {
                    registerStatus.className = 'status error';
                    registerStatus.textContent = `❌ Error: ${error.message}`;
                }
            });
            
            // Authenticate with Passkey
            authenticateBtn.addEventListener('click', async () => {
                const authOptionsUrl = document.getElementById('authOptionsUrl').value;
                const authVerifyUrl = document.getElementById('authVerifyUrl').value;
                const authenticateStatus = document.getElementById('authenticateStatus');
                
                authenticateStatus.className = 'status info';
                authenticateStatus.textContent = 'Authenticating with passkey...';
                
                try {
                    const result = await authenticateWithPasskey(authOptionsUrl, authVerifyUrl);
                    if (result) {
                        authenticateStatus.className = 'status success';
                        authenticateStatus.textContent = '✅ Authentication successful.';
                    } else {
                        authenticateStatus.className = 'status error';
                        authenticateStatus.textContent = '❌ Authentication failed.';
                    }
                } catch (error) {
                    authenticateStatus.className = 'status error';
                    authenticateStatus.textContent = `❌ Error: ${error.message}`;
                }
            });
            
            // Clear Log
            clearLogBtn.addEventListener('click', () => {
                logOutput.innerHTML = '';
            });
        });

// Add this to your existing script section
document.addEventListener('DOMContentLoaded', () => {
    // ... your existing code ...
    
    // Configure for security key testing
    const configureSecurityKeyBtn = document.getElementById('configureSecurityKeyBtn');
    const securityKeyStatus = document.getElementById('securityKeyStatus');
    
    configureSecurityKeyBtn.addEventListener('click', () => {
        // Update the authentication selection to work with security keys
        window.securityKeyTesting = true;
        
        securityKeyStatus.className = 'status success';
        securityKeyStatus.textContent = '✅ Configured for security key testing with PIN. You can now register and authenticate with your security key.';
        
        // Update the UI to reflect the change
        document.querySelectorAll('.section h2, .section p').forEach(el => {
            if (el.textContent.includes('Virtual Authenticator')) {
                el.style.opacity = '0.5';
            }
        });
        
        // Update the registration and authentication UI
        const registerStatus = document.getElementById('registerStatus');
        registerStatus.className = 'status info';
        registerStatus.textContent = 'Ready for registration with security key (will prompt for PIN)';
        
        const authenticateStatus = document.getElementById('authenticateStatus');
        authenticateStatus.className = 'status info';
        authenticateStatus.textContent = 'Ready for authentication with security key (will prompt for PIN)';
    });
});
    </script>
</body>
</html>
