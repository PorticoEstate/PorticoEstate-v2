{"version":3,"file":"popover.cjs","names":["attr","onHotReload","on","QUICK_EVENT"],"sources":["../../src/popover.ts"],"sourcesContent":["import type { ComputePositionConfig, MiddlewareState } from '@floating-ui/dom';\r\nimport {\r\n  autoUpdate,\r\n  computePosition,\r\n  limitShift,\r\n  flip,\r\n  offset,\r\n  shift,\r\n  size,\r\n} from '@floating-ui/dom';\r\nimport { attr, on, onHotReload, QUICK_EVENT } from './utils';\r\n\r\nconst ATTR_PLACEMENT = 'data-placement';\r\nconst ATTR_FLOATING = 'data-floating';\r\nconst ATTR_AUTOPLACEMENT = 'data-autoplacement';\r\nconst CSS_FLOATING = '--_ds-floating';\r\nconst CSS_FLOATING_ARROW_X = '--_ds-floating-arrow-x';\r\nconst CSS_FLOATING_ARROW_Y = '--_ds-floating-arrow-y';\r\nconst CSS_FLOATING_OVERSCROLL = '--_ds-floating-overscroll';\r\nconst POPOVERS = new Map<HTMLElement, () => void>();\r\n\r\n// Sometimes use \"ds-toggle\" event while waiting for better support of\r\n// event.source (https://developer.mozilla.org/en-US/docs/Web/API/ToggleEvent/source)\r\ntype DSToggleEvent = Partial<ToggleEvent> & {\r\n  detail?: HTMLElement;\r\n  source?: HTMLElement;\r\n};\r\n\r\nfunction handleToggle(event: DSToggleEvent) {\r\n  const { newState, target, source = event.detail } = event;\r\n\r\n  if (!isDSFloating(target)) return;\r\n  if (newState === 'closed') return POPOVERS.get(target)?.(); // Cleanup on close\r\n  if (!source || source === target) return; // No need to update\r\n  const padding = 10;\r\n  const overscroll = getCSSProp(target, CSS_FLOATING_OVERSCROLL);\r\n  const placement = attr(target, ATTR_PLACEMENT) || attr(source, ATTR_PLACEMENT) || getCSSProp(target, CSS_FLOATING);\r\n  const shiftOffset = placement.match(/left|right/gi) ? source.offsetHeight : source.offsetWidth;\r\n  const autoPlacement = attr(target, ATTR_AUTOPLACEMENT) || attr(source, ATTR_AUTOPLACEMENT);\r\n  const options = {\r\n    strategy: 'absolute',\r\n    placement,\r\n    middleware: [\r\n      offset(parseFloat(getComputedStyle(target, '::before').height) || 0),\r\n      shift({\r\n        padding,\r\n        limiter: limitShift({ offset: { mainAxis: shiftOffset } }) // Prevent from shifing away from source\r\n      }),\r\n      arrowPseudo(),\r\n      ...(autoPlacement !== 'false' ? [flip({ padding, crossAxis: false })] : []),\r\n      ...(overscroll\r\n        ? [\r\n            size({\r\n              apply({ availableHeight }) {\r\n                if (overscroll === 'fit')\r\n                  target.style.width = `${source.clientWidth}px`;\r\n                target.style.maxHeight = `${Math.max(50, availableHeight - padding * 2)}px`;\r\n              },\r\n            }),\r\n          ]\r\n        : []),\r\n    ],\r\n  } as ComputePositionConfig;\r\n  const unfloat = autoUpdate(source, target, async () => {\r\n    if (!source?.isConnected) return POPOVERS.get(target)?.(); // Cleanup if source element is removed\r\n    const { x, y } = await computePosition(source, target, options);\r\n    target.style.translate = `${x}px ${y}px`;\r\n  });\r\n  POPOVERS.set(target, () => POPOVERS.delete(target) && unfloat());\r\n}\r\n\r\nfunction handleBeforeToggle({ target: el, newState }: Partial<ToggleEvent>) {\r\n  if (newState === 'open' && isDSFloating(el)) attr(el, 'popover', 'manual'); // Make manual to prevent closing when clicking scrollbar\r\n}\r\n\r\n// Since we use manual popover, we also manually need to close on outside click\r\nfunction handleClickOutside({ target: el }: Event) {\r\n  for (const [popover] of POPOVERS)\r\n    if (!popover.contains(el as Node)) {\r\n      const id = popover.id;\r\n      const trigger = `[popovertarget=\"${id}\"],[commandfor=\"${id}\"]`;\r\n      if (!(el as Element)?.closest?.(trigger)) popover.hidePopover();\r\n    }\r\n}\r\n\r\nfunction handleKeydown(event: Partial<KeyboardEvent>) {\r\n  const last = event.key === 'Escape' && Array.from(POPOVERS.keys()).pop();\r\n  if (last) last.hidePopover();\r\n  if (last) event.preventDefault?.(); // Prevent minimize fullscreen Safari\r\n}\r\n\r\nonHotReload('popover', () => [\r\n  on(document, 'beforetoggle', handleBeforeToggle, QUICK_EVENT), // Use capture since toggle does not bubble\r\n  on(document, 'click', handleClickOutside, QUICK_EVENT), // Close open popovers on outside click\r\n  on(document, 'keydown', handleKeydown),\r\n  on(document, 'toggle ds-toggle-source', handleToggle, QUICK_EVENT), // Use capture since the toggle event does not bubble\r\n]);\r\n\r\nconst getCSSProp = (el: Element, prop: string) =>\r\n  getComputedStyle(el).getPropertyValue(prop).trim();\r\n\r\nconst isDSFloating = (el?: EventTarget | null): el is HTMLElement =>\r\n  el instanceof HTMLElement && !!getCSSProp(el, CSS_FLOATING);\r\n\r\nconst arrowPseudo = () => ({\r\n  name: 'arrowPseudo',\r\n  fn(data: MiddlewareState) {\r\n    const target = data.elements.floating;\r\n    const source = data.rects.reference;\r\n    const x = `${Math.round(source.width / 2 + source.x - data.x)}px`;\r\n    const y = `${Math.round(source.height / 2 + source.y - data.y)}px`;\r\n\r\n    target.style.setProperty(CSS_FLOATING_ARROW_X, x);\r\n    target.style.setProperty(CSS_FLOATING_ARROW_Y, y);\r\n    attr(target, ATTR_FLOATING, data.placement);\r\n    return data;\r\n  },\r\n});\r\n"],"mappings":";;;;;AAYA,MAAM,iBAAiB;AACvB,MAAM,gBAAgB;AACtB,MAAM,qBAAqB;AAC3B,MAAM,eAAe;AACrB,MAAM,uBAAuB;AAC7B,MAAM,uBAAuB;AAC7B,MAAM,0BAA0B;AAChC,MAAM,2BAAW,IAAI,KAA8B;AASnD,SAAS,aAAa,OAAsB;CAC1C,MAAM,EAAE,UAAU,QAAQ,SAAS,MAAM,WAAW;AAEpD,KAAI,CAAC,aAAa,OAAO,CAAE;AAC3B,KAAI,aAAa,SAAU,QAAO,SAAS,IAAI,OAAO,IAAI;AAC1D,KAAI,CAAC,UAAU,WAAW,OAAQ;CAClC,MAAM,UAAU;CAChB,MAAM,aAAa,WAAW,QAAQ,wBAAwB;CAC9D,MAAM,YAAYA,mBAAK,QAAQ,eAAe,IAAIA,mBAAK,QAAQ,eAAe,IAAI,WAAW,QAAQ,aAAa;CAClH,MAAM,cAAc,UAAU,MAAM,eAAe,GAAG,OAAO,eAAe,OAAO;CACnF,MAAM,gBAAgBA,mBAAK,QAAQ,mBAAmB,IAAIA,mBAAK,QAAQ,mBAAmB;CAC1F,MAAM,UAAU;EACd,UAAU;EACV;EACA,YAAY;gCACH,WAAW,iBAAiB,QAAQ,WAAW,CAAC,OAAO,IAAI,EAAE;+BAC9D;IACJ;IACA,0CAAoB,EAAE,QAAQ,EAAE,UAAU,aAAa,EAAE,CAAC;IAC3D,CAAC;GACF,aAAa;GACb,GAAI,kBAAkB,UAAU,4BAAM;IAAE;IAAS,WAAW;IAAO,CAAC,CAAC,GAAG,EAAE;GAC1E,GAAI,aACA,4BACO,EACH,MAAM,EAAE,mBAAmB;AACzB,QAAI,eAAe,MACjB,QAAO,MAAM,QAAQ,GAAG,OAAO,YAAY;AAC7C,WAAO,MAAM,YAAY,GAAG,KAAK,IAAI,IAAI,kBAAkB,UAAU,EAAE,CAAC;MAE3E,CAAC,CACH,GACD,EAAE;GACP;EACF;CACD,MAAM,2CAAqB,QAAQ,QAAQ,YAAY;AACrD,MAAI,CAAC,QAAQ,YAAa,QAAO,SAAS,IAAI,OAAO,IAAI;EACzD,MAAM,EAAE,GAAG,MAAM,4CAAsB,QAAQ,QAAQ,QAAQ;AAC/D,SAAO,MAAM,YAAY,GAAG,EAAE,KAAK,EAAE;GACrC;AACF,UAAS,IAAI,cAAc,SAAS,OAAO,OAAO,IAAI,SAAS,CAAC;;AAGlE,SAAS,mBAAmB,EAAE,QAAQ,IAAI,YAAkC;AAC1E,KAAI,aAAa,UAAU,aAAa,GAAG,CAAE,oBAAK,IAAI,WAAW,SAAS;;AAI5E,SAAS,mBAAmB,EAAE,QAAQ,MAAa;AACjD,MAAK,MAAM,CAAC,YAAY,SACtB,KAAI,CAAC,QAAQ,SAAS,GAAW,EAAE;EACjC,MAAM,KAAK,QAAQ;EACnB,MAAM,UAAU,mBAAmB,GAAG,kBAAkB,GAAG;AAC3D,MAAI,CAAE,IAAgB,UAAU,QAAQ,CAAE,SAAQ,aAAa;;;AAIrE,SAAS,cAAc,OAA+B;CACpD,MAAM,OAAO,MAAM,QAAQ,YAAY,MAAM,KAAK,SAAS,MAAM,CAAC,CAAC,KAAK;AACxE,KAAI,KAAM,MAAK,aAAa;AAC5B,KAAI,KAAM,OAAM,kBAAkB;;AAGpCC,0BAAY,iBAAiB;CAC3BC,iBAAG,UAAU,gBAAgB,oBAAoBC,0BAAY;CAC7DD,iBAAG,UAAU,SAAS,oBAAoBC,0BAAY;CACtDD,iBAAG,UAAU,WAAW,cAAc;CACtCA,iBAAG,UAAU,2BAA2B,cAAcC,0BAAY;CACnE,CAAC;AAEF,MAAM,cAAc,IAAa,SAC/B,iBAAiB,GAAG,CAAC,iBAAiB,KAAK,CAAC,MAAM;AAEpD,MAAM,gBAAgB,OACpB,cAAc,eAAe,CAAC,CAAC,WAAW,IAAI,aAAa;AAE7D,MAAM,qBAAqB;CACzB,MAAM;CACN,GAAG,MAAuB;EACxB,MAAM,SAAS,KAAK,SAAS;EAC7B,MAAM,SAAS,KAAK,MAAM;EAC1B,MAAM,IAAI,GAAG,KAAK,MAAM,OAAO,QAAQ,IAAI,OAAO,IAAI,KAAK,EAAE,CAAC;EAC9D,MAAM,IAAI,GAAG,KAAK,MAAM,OAAO,SAAS,IAAI,OAAO,IAAI,KAAK,EAAE,CAAC;AAE/D,SAAO,MAAM,YAAY,sBAAsB,EAAE;AACjD,SAAO,MAAM,YAAY,sBAAsB,EAAE;AACjD,qBAAK,QAAQ,eAAe,KAAK,UAAU;AAC3C,SAAO;;CAEV"}